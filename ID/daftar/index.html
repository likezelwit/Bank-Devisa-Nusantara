<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Registrasi Kartu Platinum | BDN</title>
    
    <!-- LIBRARIES -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- STYLE.CSS START (Style Internal) -->
    <style>
        :root {
            --primary: #0f172a; /* Navy BDN */
            --accent: #b8924e;  /* Emas BDN */
            --accent-hover: #d4a862;
            --success: #10b981;
            --bg-light: #f1f5f9;
            --white: #ffffff;
            --gray: #94a3b8;
            --danger: #ef4444;
            --radius: 16px;
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-light);
            color: var(--primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--white);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); letter-spacing: -0.5px; }
        .logo span { color: var(--accent); }
        .btn-back { 
            background: #e2e8f0; 
            color: var(--primary); 
            padding: 10px 20px; 
            border-radius: 50px; 
            text-decoration: none; 
            font-weight: 700; 
            font-size: 0.9rem;
            transition: 0.2s;
        }
        .btn-back:hover { background: #cbd5e1; }

        /* --- MAIN CONTAINER --- */
        main {
            flex: 1;
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* --- WIZARD STEPS --- */
        .wizard-step {
            display: none; /* Hidden by default */
            animation: slideUp 0.4s ease-out;
        }
        .wizard-step.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2 { margin: 0 0 10px 0; font-weight: 800; line-height: 1.2; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.5rem; }
        p.subtitle { color: var(--gray); font-size: 0.95rem; margin-bottom: 30px; line-height: 1.6; }

        /* --- DOB INPUT (New Design) --- */
        .dob-wrapper {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--white);
            padding: 10px;
            border-radius: var(--radius);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .dob-box {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .dob-box label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--gray);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .dob-box input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            padding: 5px 0;
            outline: none;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
            font-family: monospace; /* Monospace untuk alignment */
        }

        .dob-box input:focus { border-bottom-color: var(--accent); }
        .dob-separator { align-self: flex-end; font-size: 1.5rem; font-weight: bold; color: var(--gray); padding-bottom: 5px; }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: var(--primary); }
        
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: 0.3s;
            background: var(--white);
        }
        
        input:focus, select:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(184, 146, 78, 0.1);
        }

        /* Gender Selector */
        .gender-options { display: flex; gap: 10px; }
        .gender-option {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }
        .gender-option.selected { border-color: var(--accent); background: #fffbeb; color: var(--accent); }
        .gender-option i { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .gender-option span { font-size: 0.8rem; font-weight: 700; }

        /* PIN Input */
        .pin-input { letter-spacing: 10px; text-align: center; font-family: monospace; font-size: 1.5rem !important; }

        /* Checkboxes (Legal) */
        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: var(--white);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 12px;
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px; height: 20px; margin-top: 3px; accent-color: var(--accent);
        }
        .checkbox-text { font-size: 0.85rem; color: #475569; line-height: 1.4; }

        /* --- PROGRESS STEPS --- */
        .step-progress { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 30px; 
            position: relative; 
        }
        .step-progress::before {
            content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: #e2e8f0; z-index: 0; transform: translateY(-50%);
        }
        .step-dot {
            width: 30px; height: 30px; border-radius: 50%; background: #e2e8f0; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 0.8rem; color: var(--gray);
            position: relative; z-index: 1; transition: 0.3s;
        }
        .step-dot.active { background: var(--accent); color: var(--white); box-shadow: 0 0 0 4px rgba(184, 146, 78, 0.2); }
        .step-dot.completed { background: var(--primary); color: var(--white); }

        /* --- BUTTONS --- */
        .btn-primary {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* --- CARD VISUAL & FLIP --- */
        .card-container { perspective: 1000px; width: 100%; max-width: 360px; height: 230px; margin: 30px auto; }
        .card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.8s; transform-style: preserve-3d;
        }
        .card-inner.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 20px; padding: 25px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        
        .card-back { transform: rotateY(180deg); display: flex; flex-direction: column; justify-content: space-between; }

        .chip {
            width: 50px; height: 40px; background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            border-radius: 6px; margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .chip::after { content:''; position: absolute; top: 50%; width: 100%; height: 1px; background: rgba(0,0,0,0.2); left: 0; }
        .chip::before { content:''; position: absolute; left: 50%; height: 100%; width: 1px; background: rgba(0,0,0,0.2); top: 0; }

        .card-number { font-family: monospace; font-size: 1.4rem; letter-spacing: 2px; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .card-row { display: flex; justify-content: space-between; align-items: flex-end; text-align: left; }
        .card-label { font-size: 0.6rem; text-transform: uppercase; opacity: 0.7; margin-bottom: 4px; }
        .card-value { font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        
        .platinum-tag {
            font-style: italic; font-weight: 800; color: var(--accent); font-size: 1.2rem;
            position: absolute; top: 25px; right: 25px;
        }

        .mag-stripe { width: 100%; height: 40px; background: #000; margin: 20px 0; }
        .cvv-area { background: white; color: black; padding: 10px; border-radius: 4px; text-align: right; font-family: monospace; font-weight: bold; margin-top: auto; }
        .bank-msg { font-size: 0.6rem; opacity: 0.6; margin-top: 15px; text-align: left; }

        /* --- MODAL & TOAST --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 20px; text-align: center;
            max-width: 85%; animation: popIn 0.3s;
        }
        .modal-icon { font-size: 4rem; margin-bottom: 15px; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: var(--primary); color: white; padding: 12px 24px;
            border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 999; transition: 0.4s; font-weight: 600; display: flex; align-items: center; gap: 10px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        
        /* --- SCROLL CHECK ANIMATION --- */
        .scan-container {
            height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin: 20px 0; position: relative;
        }
        .scan-line {
            height: 100%; background: var(--accent); width: 0%;
            animation: scan 2s infinite ease-in-out;
        }
        @keyframes scan { 0% { width: 0; left: 0; } 50% { width: 100%; left: 0; } 100% { width: 0; left: 100%; } }

        .hidden { display: none !important; }

        /* Processing Timer */
        .timer-display { font-size: 3rem; font-weight: 800; color: var(--accent); margin: 20px 0; font-family: monospace; }
    </style>
    <!-- STYLE.CSS END -->

</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="logo">BDN<span>.</span></div>
        <a href="../../" class="btn-back"><i class="fas fa-times"></i> Batal</a>
    </nav>

    <main>
        <!-- TOAST NOTIFICATION -->
        <div id="toast" class="toast">
            <i class="fas fa-info-circle"></i> <span id="toastMsg">Pesan</span>
        </div>

        <!-- MODAL KIDS CHECK -->
        <div id="kidsModal" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-icon"><i class="fas fa-child" style="color: var(--accent);"></i></div>
                <h2>Kamu Anak-Anak!</h2>
                <p>Mode edukasi aktif. Pastikan izin dari orang tua saat membuat kartu.</p>
                <button class="btn-primary" onclick="closeModal()">Saya Mengerti</button>
            </div>
        </div>

        <!-- STEP 0: AGE GATE (REDESIGNED) -->
        <div id="step-0" class="wizard-step active">
            <h1>Tanggal Lahir</h1>
            <p class="subtitle">Masukkan tanggal lahir kamu untuk memulai pendaftaran.</p>

            <div class="dob-wrapper">
                <div class="dob-box">
                    <label>Hari</label>
                    <input type="number" id="dobDD" placeholder="DD" maxlength="2" inputmode="numeric" oninput="limitInput(this, 2)">
                </div>
                <div class="dob-separator">/</div>
                <div class="dob-box">
                    <label>Bulan</label>
                    <input type="number" id="dobMM" placeholder="MM" maxlength="2" inputmode="numeric" oninput="limitInput(this, 2)">
                </div>
                <div class="dob-separator">/</div>
                <div class="dob-box">
                    <label>Tahun</label>
                    <input type="number" id="dobYYYY" placeholder="YYYY" maxlength="4" inputmode="numeric" oninput="limitInput(this, 4)">
                </div>
            </div>

            <button class="btn-primary" onclick="checkAge()">
                Lanjut <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- PROGRESS STEPS HEADER (Visible on Step 1-6) -->
        <div id="progressHeader" class="step-progress hidden">
            <!-- Dots injected via JS -->
        </div>

        <!-- STEP 1: IDENTITAS -->
        <div id="step-1" class="wizard-step">
            <h2>Identitas Diri</h2>
            <p class="subtitle">Langkah 1 dari 7</p>

            <div class="form-group">
                <label>Jenis Kelamin</label>
                <div class="gender-options">
                    <div class="gender-option" onclick="selectGender('Laki-laki', this)">
                        <i class="fas fa-mars"></i>
                        <span>Laki-laki</span>
                    </div>
                    <div class="gender-option" onclick="selectGender('Perempuan', this)">
                        <i class="fas fa-venus"></i>
                        <span>Perempuan</span>
                    </div>
                </div>
                <input type="hidden" id="genderInput">
            </div>

            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" id="fullName" placeholder="Contoh: Budi Santoso">
            </div>

            <div class="form-group">
                <label>Nama Sekolah</label>
                <input type="text" id="schoolName" placeholder="Contoh: SD Negeri 01 Jakarta">
            </div>

            <button class="btn-primary" onclick="validateAndNext(1)">Lanjut <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- STEP 2: KEWAJIBAN & TUJUAN -->
        <div id="step-2" class="wizard-step">
            <h2>Kewajiban</h2>
            <p class="subtitle">Langkah 2 dari 7</p>

            <div class="form-group">
                <label>Nama Guru Wali</label>
                <input type="text" id="teacherName" placeholder="Nama Guru">
            </div>

            <div class="form-group">
                <label>Perizinan Guru</label>
                <select id="teacherPermit">
                    <option value="">-- Pilih Status --</option>
                    <option value="Sudah Diizinkan">Sudah Diizinkan</option>
                    <option value="Belum Diizinkan">Belum Diizinkan</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tujuan Pembuatan Kartu</label>
                <select id="cardPurpose">
                    <option value="">-- Pilih Tujuan --</option>
                    <option value="Edukasi Keuangan">Edukasi Keuangan</option>
                    <option value="Tabungan Hadiah">Tabungan Hadiah</option>
                    <option value="Tugas Sekolah">Tugas Sekolah</option>
                </select>
            </div>

            <div class="form-group">
                <label>Pengelola Kartu</label>
                <select id="cardManager">
                    <option value="">-- Siapa Mengelola? --</option>
                    <option value="Orang Tua">Orang Tua</option>
                    <option value="Saya Sendiri">Saya Sendiri</option>
                </select>
            </div>

            <button class="btn-primary" onclick="validateAndNext(2)">Lanjut <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- STEP 3: LOKASI & MATA UANG -->
        <div id="step-3" class="wizard-step">
            <h2>Lokasi</h2>
            <p class="subtitle">Langkah 3 dari 7</p>

            <div class="form-group">
                <label>Tinggal di Negara</label>
                <select id="countrySelect" onchange="updateCurrency()">
                    <option value="">-- Pilih Negara --</option>
                    <option value="Indonesia">Indonesia</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="Singapura">Singapura</option>
                    <option value="Amerika Serikat">Amerika Serikat</option>
                    <option value="Jepang">Jepang</option>
                </select>
            </div>

            <div class="info-box" style="background: #e0f2fe; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-coins" style="color: var(--primary);"></i>
                    <div>
                        <small style="display: block; color: #64748b;">Mata Uang Terdeteksi</small>
                        <strong id="currencyDisplay" style="font-size: 1.2rem;">-</strong>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="validateAndNext(3)">Lanjut <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- STEP 4: PIN -->
        <div id="step-4" class="wizard-step">
            <h2>Keamanan</h2>
            <p class="subtitle">Langkah 4 dari 7</p>

            <div class="form-group">
                <label>Buat PIN 6 Digit</label>
                <input type="password" id="pinInput" class="pin-input" maxlength="6" inputmode="numeric" placeholder="000000">
            </div>

            <div class="form-group">
                <label>Konfirmasi PIN</label>
                <input type="password" id="pinConfirm" class="pin-input" maxlength="6" inputmode="numeric" placeholder="000000">
            </div>

            <button class="btn-primary" onclick="validateAndNext(4)">Lanjut <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- STEP 5: KELAYAKAN (SCROLL CHECK) -->
        <div id="step-5" class="wizard-step">
            <h2>Pengecekan Kelayakan</h2>
            <p class="subtitle">Langkah 5 dari 7</p>
            
            <div style="text-align: center; margin: 40px 0;">
                <i class="fas fa-microchip fa-3x" style="color: var(--accent); margin-bottom: 20px;"></i>
                <div class="scan-container">
                    <div class="scan-line"></div>
                </div>
                <p id="scanText" style="font-weight: 600; min-height: 24px;">Menghubungkan ke server pusat...</p>
            </div>

            <!-- Hidden button triggered by JS timer -->
            <button id="btnStep5" class="btn-primary hidden" onclick="validateAndNext(5)">Lanjut <i class="fas fa-check"></i></button>
        </div>

        <!-- STEP 6: PERJANJIAN -->
        <div id="step-6" class="wizard-step">
            <h2>Perjanjian & Sanksi</h2>
            <p class="subtitle">Langkah 6 dari 7</p>

            <div style="max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                <h4 style="margin-top:0">Syarat & Ketentuan</h4>
                <p style="font-size: 0.85rem; color: #64748b; text-align: justify;">
                    1. Kartu ini adalah simulasi edukasi dan tidak memiliki nilai legal sebagai alat pembayaran yang sah.<br>
                    2. Pemegang kartu wajib menjaga kerahasiaan PIN.<br>
                    3. Penyalahgunaan data seperti memasukkan data orang lain tanpa izin dilarang keras.<br>
                    4. Sanksi pelanggaran adalah pemblokiran kartu secara permanen dari sistem simulasi.
                </p>
            </div>

            <div class="checkbox-wrapper">
                <input type="checkbox" id="check1" onchange="checkLegal()">
                <div class="checkbox-text">Saya setuju dengan data yang saya masukkan adalah benar.</div>
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="check2" onchange="checkLegal()">
                <div class="checkbox-text">Saya memahami sanksi jika melakukan pelanggaran.</div>
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="check3" onchange="checkLegal()">
                <div class="checkbox-text">Saya bertanggung jawab atas penggunaan kartu ini.</div>
            </div>

            <button id="btnStep6" class="btn-primary" disabled onclick="validateAndNext(6)">Ajukan Penerbitan <i class="fas fa-paper-plane"></i></button>
        </div>

        <!-- STEP 7: PENERBITAN (TIMER) -->
        <div id="step-7" class="wizard-step">
            <h2>Penerbitan Kartu</h2>
            <p class="subtitle">Langkah 7 dari 7</p>

            <div style="text-align: center; margin-top: 40px;">
                <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
                <p>Sedang mencetak kartu fisik digital...</p>
                
                <div id="countdownTimer" class="timer-display">60</div>
                <p style="font-size: 0.8rem; color: var(--gray);">Detik tersisa</p>
            </div>
        </div>

        <!-- FINAL STEP: KARTU -->
        <div id="final-step" class="wizard-step">
            <div style="text-align: center; margin-bottom: 30px;">
                <i class="fas fa-check-circle fa-3x" style="color: var(--success);"></i>
                <h2 style="margin-top: 10px;">Kartu Berhasil!</h2>
            </div>

            <div class="card-container">
                <div class="card-inner" id="cardElement">
                    <!-- FRONT -->
                    <div class="card-face card-front">
                        <div class="platinum-tag">PLATINUM</div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 800;">BDN</span>
                            <div class="chip"></div>
                        </div>
                        <div style="margin-top: 30px;">
                            <small style="font-size: 0.6rem; opacity: 0.7;">NOMOR KARTU</small>
                            <div class="card-number" id="cardNoDisplay">0000 0000 0000 0000</div>
                        </div>
                        <div class="card-row">
                            <div>
                                <div class="card-label">NAMA</div>
                                <div class="card-value" id="cardNameDisplay">NAMA ANDA</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="card-label">VERSI</div>
                                <div class="card-value">V.2.0</div>
                            </div>
                        </div>
                    </div>
                    <!-- BACK -->
                    <div class="card-face card-back">
                        <div class="mag-stripe"></div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-size: 0.8rem; font-weight: bold;">BANK DEVISA NUSANTARA</span>
                            <i class="fas fa-lock" style="font-size: 0.8rem;"></i>
                        </div>
                        <div style="text-align: right; margin-bottom: 10px;">
                            <small style="font-size: 0.6rem;">KODE KEAMANAN (CVV)</small>
                            <div style="background: white; color: black; padding: 5px 10px; border-radius: 4px; display: inline-block; font-family: monospace; font-weight: bold;" id="cvvDisplay">123</div>
                        </div>
                        <div class="bank-msg">
                            Kartu ini berlaku seumur hidup selama pemegang kartu taat aturan. Jika ditemukan harap kembalikan ke kantor BDN terdekat.
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="flipCard()" style="background: var(--gray);"><i class="fas fa-sync-alt"></i> Putar</button>
                <button class="btn-primary" onclick="downloadCard()"><i class="fas fa-camera"></i> Simpan</button>
            </div>
        </div>

    </main>

    <!-- SCRIPT.JS START (Script Internal) -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- CONFIG ---
        const SUPABASE_URL = 'https://ndopnxzbaygohzshqphi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kb3BueHpiYXlnb2h6c2hxcGhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MzM4ODQsImV4cCI6MjA3OTMwOTg4NH0.nZC5kOVJeMAtfXlwchokXK4FLtPkPoUrxPQUzrz2C8I';
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        let formData = {};
        let currentStep = 0;
        const totalSteps = 7;
        let countdownInterval;

        // --- GLOBAL FUNCTIONS (Attached to window for HTML onclick) ---
        window.limitInput = (el, max) => {
            if (el.value.length > max) el.value = el.value.slice(0, max);
        }

        window.showToast = (msg, isError = false) => {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            toastMsg.innerText = msg;
            toast.style.background = isError ? 'var(--danger)' : 'var(--primary)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        window.selectGender = (val, el) => {
            document.querySelectorAll('.gender-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('genderInput').value = val;
        }

        window.updateCurrency = () => {
            const map = {
                'Indonesia': 'IDR (Rp)',
                'Malaysia': 'MYR (RM)',
                'Singapura': 'SGD ($)',
                'Amerika Serikat': 'USD ($)',
                'Jepang': 'JPY (Â¥)'
            };
            const country = document.getElementById('countrySelect').value;
            const display = document.getElementById('currencyDisplay');
            if(map[country]) {
                display.innerText = map[country];
                formData.currency = map[country];
            } else {
                display.innerText = '-';
            }
        }

        window.checkLegal = () => {
            const c1 = document.getElementById('check1').checked;
            const c2 = document.getElementById('check2').checked;
            const c3 = document.getElementById('check3').checked;
            document.getElementById('btnStep6').disabled = !(c1 && c2 && c3);
        }

        window.closeModal = () => {
            document.getElementById('kidsModal').style.display = 'none';
        }

        window.flipCard = () => {
            document.getElementById('cardElement').classList.toggle('flipped');
        }

        // --- CORE LOGIC ---

        window.checkAge = () => {
            const dd = document.getElementById('dobDD').value;
            const mm = document.getElementById('dobMM').value;
            const yyyy = document.getElementById('dobYYYY').value;

            if (!dd || !mm || !yyyy || dd.length < 2 || mm.length < 2 || yyyy.length < 4) {
                return showToast("Mohon lengkapi tanggal lahir!", true);
            }

            const dob = new Date(`${yyyy}-${mm}-${dd}`);
            if(isNaN(dob.getTime())) return showToast("Tanggal tidak valid!", true);

            const age = new Date().getFullYear() - dob.getFullYear();
            
            // Simpan data DOB
            formData.dob = `${dd}/${mm}/${yyyy}`;
            formData.age = age;

            if (age < 7) {
                return showToast("Maaf, minimal usia 7 tahun.", true);
            }

            // Setup Progress Dots
            const header = document.getElementById('progressHeader');
            header.innerHTML = '';
            header.classList.remove('hidden');
            for(let i=1; i<=7; i++) {
                const dot = document.createElement('div');
                dot.className = `step-dot ${i===1 ? 'active' : ''}`;
                dot.innerText = i;
                dot.id = `dot-${i}`;
                header.appendChild(dot);
            }

            // Check Kids Mode
            if (age < 17) {
                document.getElementById('kidsModal').style.display = 'flex';
            }

            goToStep(1);
        }

        window.validateAndNext = (step) => {
            // Validasi per langkah
            if(step === 1) {
                const gender = document.getElementById('genderInput').value;
                const name = document.getElementById('fullName').value;
                const school = document.getElementById('schoolName').value;
                if(!gender || !name || !school) return showToast("Mohon lengkapi semua data!", true);
                formData.gender = gender;
                formData.name = name;
                formData.school = school;
            }
            else if(step === 2) {
                const teacher = document.getElementById('teacherName').value;
                const permit = document.getElementById('teacherPermit').value;
                const purpose = document.getElementById('cardPurpose').value;
                const manager = document.getElementById('cardManager').value;
                if(!teacher || !permit || !purpose || !manager) return showToast("Data belum lengkap!", true);
                formData.teacher = teacher;
                formData.permit = permit;
                formData.purpose = purpose;
                formData.manager = manager;
            }
            else if(step === 3) {
                if(!document.getElementById('countrySelect').value) return showToast("Pilih negara!", true);
                formData.country = document.getElementById('countrySelect').value;
            }
            else if(step === 4) {
                const p1 = document.getElementById('pinInput').value;
                const p2 = document.getElementById('pinConfirm').value;
                if(p1.length !== 6 || p2.length !== 6) return showToast("PIN harus 6 digit!", true);
                if(p1 !== p2) return showToast("Konfirmasi PIN tidak cocok!", true);
                formData.pin = p1;
            }
            else if(step === 6) {
                // Legal check handled by button disabled state
            }

            goToStep(step + 1);
        }

        function goToStep(stepIndex) {
            // Hide current
            document.querySelector('.wizard-step.active').classList.remove('active');
            
            // Update Progress Dots
            document.querySelectorAll('.step-dot').forEach(d => d.classList.remove('active', 'completed'));
            for(let i=1; i<stepIndex; i++) {
                document.getElementById(`dot-${i}`).classList.add('completed');
            }
            if(stepIndex <= 7) {
                document.getElementById(`dot-${stepIndex}`).classList.add('active');
            }

            // Show next
            const nextId = stepIndex === 8 ? 'final-step' : `step-${stepIndex}`;
            document.getElementById(nextId).classList.add('active');
            currentStep = stepIndex;

            // Logic spesifik per step
            if(stepIndex === 5) runScanSimulation();
            if(stepIndex === 7) runTimer();
            if(stepIndex === 8) submitData();
        }

        function runScanSimulation() {
            const txt = document.getElementById('scanText');
            const btn = document.getElementById('btnStep5');
            const messages = [
                "Memverifikasi data biometrik...",
                "Mengecek database keuangan...",
                "Validasi sekolah & guru...",
                "Analisis karakteristik...",
                "Kelayakan DITERIMA."
            ];
            let i = 0;
            txt.innerText = messages[0];
            
            const interval = setInterval(() => {
                i++;
                if(i < messages.length) {
                    txt.innerText = messages[i];
                } else {
                    clearInterval(interval);
                    btn.classList.remove('hidden');
                }
            }, 1000);
        }

        function runTimer() {
            let timeLeft = 60;
            const display = document.getElementById('countdownTimer');
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                display.innerText = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    goToStep(8); // Go to Final
                }
            }, 1000);
        }

        async function submitData() {
            // Generate Card Details
            const prefix = "4512";
            const mid = Math.floor(1000 + Math.random() * 9000);
            const mid2 = Math.floor(1000 + Math.random() * 9000);
            const last = Math.floor(1000 + Math.random() * 9000);
            const cardNo = `${prefix} ${mid} ${mid2} ${last}`;
            const cvv = Math.floor(100 + Math.random() * 900);

            // Update UI
            document.getElementById('cardNoDisplay').innerText = cardNo;
            document.getElementById('cardNameDisplay').innerText = formData.name.toUpperCase();
            document.getElementById('cvvDisplay').innerText = cvv;

            // Simpan ke Supabase
            try {
                await _supabase.from('pendaftaran_simulasi').insert([{
                    nama_lengkap: formData.name,
                    nomor_kartu: cardNo,
                    detail_data: formData,
                    created_at: new Date().toISOString()
                }]);
                console.log("Data saved");
            } catch(e) {
                console.error("Error saving", e);
            }

            // Confetti
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        window.downloadCard = () => {
            const card = document.getElementById('cardElement');
            // Hide flip effect momentarily for clean shot or capture front only
            html2canvas(card, { scale: 3 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `KARTU_BDN_${formData.name.replace(/\s/g, '_')}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast("Gambar tersimpan!");
            });
        }
    </script>
    <!-- SCRIPT.JS END -->

</body>
</html>
