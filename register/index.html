<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Registrasi Nasabah | BDN</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- STYLE CSS --- */
        :root {
            --navy: #0f172a;
            --gold: #b8924e;
            --blue: #4f46e5;
            --bg: #f8fafc;
            --white: #ffffff;
            --gray: #64748b;
            --red: #ef4444;
            --green: #22c55e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--navy); overflow-x: hidden; line-height: 1.5; }

        /* NAVIGATION */
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 0 5%; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; height: 70px; }
        .logo { font-size: 1.3rem; font-weight: 800; letter-spacing: -1px; }
        .logo span { color: var(--gold); }
        .btn-back { text-decoration: none; color: var(--gray); font-weight: 700; font-size: 0.7rem; border: 1.5px solid #e2e8f0; padding: 8px 14px; border-radius: 10px; cursor: pointer; }

        /* LAYOUT */
        .container { padding: 1rem; display: flex; justify-content: center; min-height: calc(100vh - 70px); align-items: flex-start; }
        .form-wrapper { background: white; width: 100%; max-width: 480px; padding: 1.5rem; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; margin-top: 0.5rem; }

        /* PROGRESS BAR */
        .progress-container { display: flex; justify-content: space-between; position: relative; margin-bottom: 2rem; padding: 0 5px; }
        .progress-bar-bg { position: absolute; top: 15px; left: 0; width: 100%; height: 2px; background: #f1f5f9; z-index: 1; }
        .progress-line { width: 0%; height: 100%; background: var(--blue); transition: 0.5s ease; }
        .circle { width: 32px; height: 32px; background: white; border: 2px solid #e2e8f0; border-radius: 50%; z-index: 2; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; font-weight: 800; color: var(--gray); transition: 0.3s; }
        .circle.active { border-color: var(--blue); color: var(--blue); transform: scale(1.1); background: #f8faff; }
        .circle.completed { background: var(--blue); border-color: var(--blue); color: white; }

        /* STEPS */
        .step { display: none; }
        .step.active { display: block; animation: mobileFadeUp 0.4s ease-out forwards; }
        @keyframes mobileFadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .step h2 { font-size: 1.2rem; font-weight: 800; margin-bottom: 1.2rem; color: var(--navy); text-align: left; }

        /* INPUTS */
        .input-group { text-align: left; margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.65rem; font-weight: 800; color: var(--gray); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-group input, .input-group select {
            width: 100%; height: 55px; padding: 0 1rem; border: 2px solid #f1f5f9; border-radius: 14px;
            font-size: 16px !important; font-weight: 600; outline: none; transition: 0.3s; background: #f8fafc;
        }

        /* BUTTONS GENERAL */
        .btn-primary {
            width: 100%; height: 60px; background: var(--navy); color: white; border: none; border-radius: 18px;
            font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-alt { background: white; color: var(--navy); border: 2px solid #e2e8f0; }
        .nav-buttons-split { display: flex; gap: 10px; margin-top: 10px; }
        .nav-buttons-split button { flex: 1; }

        /* AGE GATE SPECIAL */
        .age-gate-box { padding: 20px 0; }
        .age-gate-box input { text-align: center; font-size: 1.2rem; letter-spacing: 2px; }

        /* FINAL STEP BUTTONS */
        .button-group-final { margin-top: 30px; display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .btn-save { background: var(--green) !important; height: 65px; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.2); }
        .btn-flip { width: 100%; height: 55px; background: #f1f5f9; color: var(--navy); border: 2px solid #e2e8f0; border-radius: 18px; font-weight: 700; cursor: pointer; }

        /* CARD 3D SYSTEM */
        .card-scene { width: 100%; max-width: 350px; aspect-ratio: 1.58 / 1; perspective: 1200px; margin: 20px auto; }
        .card-inner { width: 100%; height: 100%; position: relative; transition: transform 0.9s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg) rotateZ(1deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 20px; padding: 1.5rem; }

        .card-front {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; flex-direction: column; justify-content: space-between; color: white; text-align: left;
        }
        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; }
        .footer-left { text-align: left; }
        .footer-right { text-align: right; }

        .chip-card { width: 45px; height: 35px; background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); border-radius: 6px; margin-top: 10px; }
        .bank-name { font-size: 0.7rem; font-weight: 800; color: var(--gold); letter-spacing: 1.5px; }
        .card-number { font-size: 1.3rem; letter-spacing: 2px; font-family: monospace; margin: 10px 0; }
        .card-series { font-weight: 800; color: var(--gold); letter-spacing: 1px; font-size: 0.8rem; }

        .card-back { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); transform: rotateY(180deg); padding: 0; display: flex; flex-direction: column; }
        .mag-stripe { width: 100%; height: 40px; background: #000; margin-top: 20px; }
        .cvv-area { margin: 20px 1.5rem 10px; height: 35px; background: #eee; display: flex; justify-content: flex-end; align-items: center; padding-right: 15px; border-radius: 4px; overflow: hidden; }
        .cvv-code { font-weight: 700; color: #000; font-family: monospace; font-size: 1.1rem; }
        .card-terms { padding: 0 1.5rem; font-size: 7px; color: rgba(255,255,255,0.4); line-height: 1.2; text-align: left; }

        /* UTILS & ANIMATION */
        .spinner-large { border: 4px solid #f1f5f9; border-top-color: var(--blue); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s infinite linear; margin: 0 auto 1.2rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .reveal-text { opacity: 0; font-size: 0.75rem; font-weight: 700; margin-bottom: 6px; text-align: left; padding-left: 10px; border-left: 3px solid #e2e8f0; transition: 0.5s; }
        .reveal-text.show { opacity: 1; border-left-color: var(--gold); }
        .final-glow { animation: cardGlow 2s infinite alternate; }
        @keyframes cardGlow { from { box-shadow: 0 0 20px rgba(79, 70, 229, 0.2); } to { box-shadow: 0 0 40px rgba(184, 146, 78, 0.6); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">BDN<span>.</span></div>
        <a href="../" class="btn-back">BATAL</a>
    </nav>

    <main class="container">
        <div class="form-wrapper">
            <!-- AGE GATE / STEP 0 -->
            <div id="ageGate" class="step active">
                <h2>Selamat Datang</h2>
                <div class="age-gate-box">
                    <p style="margin-bottom:15px; color:var(--gray)">Silahkan masukkan Tanggal Lahir untuk memulai registrasi.</p>
                    <div class="input-group">
                        <label>TANGGAL LAHIR</label>
                        <input type="date" id="inputDOB">
                    </div>
                    <button class="btn-primary" onclick="checkAge()">MULAI REGISTRASI</button>
                </div>
            </div>

            <!-- PROGRESS BAR (Hidden initially) -->
            <div id="progressContainer" class="progress-container" style="display:none;">
                <div class="progress-bar-bg"><div class="progress-line" id="progressLine"></div></div>
                <!-- Circles will be generated by JS -->
                <div id="circleWrapper" style="display:flex; justify-content:space-between; width:100%; position:relative; z-index:2;"></div>
            </div>

            <!-- DYNAMIC FORM CONTENT -->
            <div id="formContent" class="form-content">
                <!-- Steps will be injected here via JS -->
            </div>
            
            <!-- FINAL REVEAL TEMPLATE (Hidden by default) -->
            <div id="finalStepTemplate" class="step" style="display:none;">
                <div class="processing-area">
                    <div class="loading-box">
                        <div class="spinner-large"></div>
                        <div class="queue-status">Proses Enkripsi & Unique ID...</div>
                        <div class="timer-display">Estimasi: --</div>
                    </div>
                </div>

                <div class="final-reveal" style="display:none;">
                    <div class="reveal-text rev-1">SERVER VALIDATED [OK]</div>
                    <div class="reveal-text rev-2" style="color:#b8924e">SMART CHIP ACTIVATED [OK]</div>
                    <div class="reveal-text rev-3" style="color:#22c55e">STATUS : PLATINUM ACTIVE</div>
                    
                    <div class="card-scene">
                        <div class="card-inner card-inner-ref">
                            <div class="capture-area card-face card-front">
                                <div class="card-header">
                                    <span class="bank-name">BANK DEVISA NUSANTARA</span>
                                    <div class="chip-card"></div>
                                </div>
                                <div class="card-body">
                                    <div class="card-number display-no">0000 0000 0000 0000</div>
                                </div>
                                <div class="card-footer">
                                    <div class="footer-left">
                                        <small>CARD HOLDER</small>
                                        <div class="name-display display-name">NAME</div>
                                    </div>
                                    <div class="footer-right">
                                        <div class="card-series">PLATINUM</div>
                                    </div>
                                </div>
                            </div>

                            <div class="card-face card-back">
                                <div class="mag-stripe"></div>
                                <div class="cvv-area">
                                    <span style="font-size: 8px; color:#000; margin-right: 5px;">CVV</span>
                                    <span class="cvv-code cvv-display">***</span>
                                </div>
                                <div class="card-terms">
                                    Kartu ini adalah milik Bank Devisa Nusantara. Segala bentuk penyalahgunaan akan diproses sesuai hukum negara.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group-final">
                        <button class="btn-primary btn-save btn-download">ðŸ“¸ SIMPAN GAMBAR KARTU</button>
                        <button class="btn-flip btn-flip-action">ðŸ”„ PUTAR KARTU</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXYDqFmhO8nacuX-hVnNsXMmpeqwYlW7U",
            authDomain: "wifist-d3588.firebaseapp.com",
            databaseURL: "https://wifist-d3588-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            projectId: "wifist-d3588"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- KONFIGURASI TAHAPAN ---
        const MODES = {
            child: {
                name: "Anak (7-10 Tahun)",
                steps: [
                    { id: 1, title: "01. Identitas Anak", fields: [
                        { id: "inputNama", label: "Nama Lengkap", type: "text", placeholder: "NAMA LENGKAP", validate: "min3" },
                        { id: "inputDOB_Display", label: "Tanggal Lahir", type: "text", readonly: true }
                    ]},
                    { id: 2, title: "02. Cita-Cita", fields: [
                        { id: "jobType", label: "Cita-cita", type: "select", options: ["-- Pilih --", "Pelajar", "Dokter", "Pilot", "Ilmuwan", "Polisi", "Lainnya"] }
                    ]},
                    { id: 3, title: "03. Data Wali", fields: [
                        { id: "waliName", label: "Nama Orang Tua/Wali", type: "text", placeholder: "Nama Wali", validate: "min3" }
                    ]},
                    { id: 4, title: "04. Keamanan", fields: [
                        { id: "inputPW", label: "6 Digit PIN", type: "password", maxlength: 6, validate: "len6" }
                    ]},
                    { id: 5, title: "05. Janji Nasabah", fields: [
                        { id: "checkAgree", label: "Saya Janji Rajin Menabung", type: "checkbox", validate: "checked" }
                    ]},
                    { id: 6, title: "06. Lokasi", fields: [
                        { id: "countrySelect", label: "Negara Domisili", type: "select", options: ["-- Pilih --", "Indonesia (IDR)", "Amerika Serikat (USD)", "Inggris (GBP)"], validate: "selected" }
                    ]},
                    { id: 7, title: "Finalisasi", isFinal: true }
                ]
            },
            teen: {
                name: "Remaja (11-17 Tahun)",
                steps: [
                    { id: 1, title: "01. Identitas", fields: [
                        { id: "inputNama", label: "Nama Lengkap", type: "text", placeholder: "NAMA ANDA", validate: "min3" },
                        { id: "inputDOB_Display", label: "Tanggal Lahir", type: "text", readonly: true }
                    ]},
                    { id: 2, title: "02. Kontak", fields: [
                        { id: "inputWA", label: "WhatsApp", type: "tel", placeholder: "08xxxxxxxxxx", validate: "digit11-13" },
                        { id: "inputEmail", label: "Email", type: "email", placeholder: "nama@email.com", validate: "email" }
                    ]},
                    { id: 3, title: "03. Pendidikan", fields: [
                        { id: "jobType", label: "Nama Sekolah", type: "text", placeholder: "SMA Negeri 1", validate: "min3" }
                    ]},
                    { id: 4, title: "04. Finansial", fields: [
                        { id: "incomeSource", label: "Sumber Uang Saku", type: "select", options: ["-- Pilih --", "Orang Tua", "Hadiah", "Part Time", "Lainnya"], validate: "selected" }
                    ]},
                    { id: 5, title: "05. Kontak Darurat", fields: [
                        { id: "emName", label: "Nama Penanggung Jawab", type: "text", placeholder: "Nama Orang Tua", validate: "min3" },
                        { id: "emPhone", label: "No. HP Darurat", type: "tel", placeholder: "08xxxxxxxxxx", validate: "digit10-13" }
                    ]},
                    { id: 6, title: "06. Keamanan", fields: [
                        { id: "inputPW", label: "6 Digit PIN", type: "password", maxlength: 6, validate: "len6" }
                    ]},
                    { id: 7, title: "07. Analisis Data", type: "loading", msg: "Menghubungkan ke Database Sekolah..." },
                    { id: 8, title: "08. Konfirmasi", fields: [
                        { id: "checkAgree", label: "Saya bertanggung jawab", type: "checkbox", validate: "checked" }
                    ]},
                    { id: 9, title: "09. Legalitas", fields: [
                        { id: "checkLegal", label: "Setuju Syarat & Ketentuan", type: "checkbox", validate: "checked" }
                    ]},
                    { id: 10, title: "10. Lokasi", fields: [
                        { id: "countrySelect", label: "Negara Domisili", type: "select", options: ["-- Pilih --", "Indonesia (IDR)", "Amerika Serikat (USD)", "Inggris (GBP)"], validate: "selected" }
                    ]},
                    { id: 11, title: "Finalisasi", isFinal: true }
                ]
            },
            adult: {
                name: "Dewasa (18+ Tahun)",
                steps: [
                    { id: 1, title: "01. Identitas", fields: [
                        { id: "inputNama", label: "Nama Lengkap KTP", type: "text", placeholder: "NAMA LENGKAP", validate: "min3" },
                        { id: "inputDOB_Display", label: "Tanggal Lahir", type: "text", readonly: true }
                    ]},
                    { id: 2, title: "02. Kontak Utama", fields: [
                        { id: "inputWA", label: "WhatsApp", type: "tel", placeholder: "08xxxxxxxxxx", validate: "digit11-13" },
                        { id: "inputEmail", label: "Email", type: "email", placeholder: "nama@email.com", validate: "email" }
                    ]},
                    { id: 3, title: "03. Domisili", fields: [
                        { id: "address", label: "Alamat Lengkap", type: "text", placeholder: "Jalan, No Rumah...", validate: "min5" }
                    ]},
                    { id: 4, title: "04. Profesi", fields: [
                        { id: "jobType", label: "Pekerjaan", type: "text", placeholder: "Posisi & Perusahaan", validate: "min3" }
                    ]},
                    { id: 5, title: "05. Pendapatan", fields: [
                        { id: "income", label: "Penghasilan Bulanan", type: "tel", placeholder: "Contoh: 10000000", validate: "digit" }
                    ]},
                    { id: 6, title: "06. Sumber Dana", fields: [
                        { id: "incomeSource", label: "Sumber Dana", type: "select", options: ["-- Pilih --", "Gaji", "Usaha", "Investasi", "Warisan"], validate: "selected" }
                    ]},
                    { id: 7, title: "07. Tujuan Akun", fields: [
                        { id: "accPurpose", label: "Tujuan Pembukaan", type: "select", options: ["-- Pilih --", "Transaksi", "Tabungan", "Bisnis"], validate: "selected" }
                    ]},
                    { id: 8, title: "08. Kontak Darurat", fields: [
                        { id: "emName", label: "Nama Darurat", type: "text", validate: "min3" },
                        { id: "emRelation", label: "Hubungan", type: "text", placeholder: "Keluarga", validate: "min3" }
                    ]},
                    { id: 9, title: "09. Keamanan 1", fields: [
                        { id: "inputPW", label: "6 Digit PIN", type: "password", maxlength: 6, validate: "len6" }
                    ]},
                    { id: 10, title: "10. Keamanan 2", fields: [
                        { id: "secQuestion", label: "Pertanyaan Rahasia", type: "text", placeholder: "Nama Ibu Kandung?", validate: "min3" }
                    ]},
                    { id: 11, title: "11. Background Check", type: "loading", msg: "Melakukan Sinkronisasi Database..." },
                    { id: 12, title: "12. BI Checking", type: "loading", msg: "Analisis SLIK & Skor Kredit..." },
                    { id: 13, title: "13. Konfirmasi", fields: [
                        { id: "checkAgree", label: "Saya menyatakan data benar", type: "checkbox", validate: "checked" }
                    ]},
                    { id: 14, title: "14. Kepatuhan", fields: [
                        { id: "checkCompliance", label: "Setujui Kebijakan AML", type: "checkbox", validate: "checked" }
                    ]},
                    { id: 15, title: "15. Lokasi", fields: [
                        { id: "countrySelect", label: "Negara Domisili", type: "select", options: ["-- Pilih --", "Indonesia (IDR)", "Amerika Serikat (USD)", "Inggris (GBP)", "Singapura (SGD)", "Jepang (JPY)"], validate: "selected" }
                    ]},
                    { id: 16, title: "Finalisasi", isFinal: true }
                ]
            }
        };

        // --- GLOBAL VARIABLES ---
        let currentMode = null; 
        let currentStep = 1;
        let isFlipLocked = false;
        let finalDataReady = null;
        let userDOB = ""; 

        // --- AGE GATE LOGIC ---
        window.checkAge = () => {
            const dobInput = document.getElementById('inputDOB').value;
            if(!dobInput) { alert("Harap pilih tanggal lahir!"); return; }
            
            userDOB = dobInput;
            const dob = new Date(dobInput);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }

            if(age < 7) { alert("Maaf, usia minimal 7 tahun."); return; }
            
            // Tentukan Mode
            if(age >= 7 && age <= 10) currentMode = 'child';
            else if(age >= 11 && age <= 17) currentMode = 'teen';
            else currentMode = 'adult';

            document.getElementById('ageGate').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'flex';
            initApp();
        };

        function initApp() {
            const config = MODES[currentMode];
            const formContent = document.getElementById('formContent');
            const circleWrapper = document.getElementById('circleWrapper');
            
            // 1. Build Progress Circles
            circleWrapper.innerHTML = '';
            for(let i=1; i<=config.steps.length; i++) {
                const c = document.createElement('div');
                c.className = 'circle';
                c.id = `circle-${i}`;
                c.innerText = i;
                circleWrapper.appendChild(c);
            }

            // 2. Build Steps HTML
            formContent.innerHTML = '';
            config.steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.id = `step${index + 1}`;
                
                if (step.isFinal) {
                    // Clone Template
                    const template = document.getElementById('finalStepTemplate');
                    stepDiv.innerHTML = template.innerHTML;
                    
                    // SETUP LISTENERS KHUSUS UNTUK FINAL STEP
                    const btnDownload = stepDiv.querySelector('.btn-download');
                    const btnFlip = stepDiv.querySelector('.btn-flip-action');
                    
                    if(btnDownload) btnDownload.onclick = () => takeScreenshot(stepDiv);
                    if(btnFlip) btnFlip.onclick = () => toggleFlip(stepDiv);
                    
                } else if (step.type === 'loading') {
                    // ID unik untuk elemen loading
                    const loadId = `load-${step.id}`;
                    const btnId = `btn-${step.id}`;
                    const errId = `err-${step.id}`;

                    stepDiv.innerHTML = `
                        <h2>${step.title}</h2>
                        <div class="loading-box">
                            <div class="spinner-large"></div>
                            <p id="${loadId}">${step.msg}</p>
                        </div>
                        <div id="${errId}" style="display:none; margin-top:15px;">
                            <button class="btn-alt" onclick="window.prevStep()">Perbaiki Data</button>
                        </div>
                        <button class="btn-primary" id="${btnId}" style="display:none" onclick="window.nextStep(${index + 2})">Lanjutkan</button>
                    `;

                    // Simpan referensi tombol ke dalam elemen step untuk diakses nanti
                    stepDiv.dataset.nextBtnId = btnId;
                    stepDiv.dataset.loadMsgId = loadId;
                    stepDiv.dataset.errId = errId;
                    
                } else {
                    // Standard Form Step
                    let fieldsHTML = '';
                    step.fields.forEach(field => {
                        let readonlyAttr = field.readonly ? 'readonly' : '';
                        let valueAttr = field.id === 'inputDOB_Display' ? `value="${userDOB}"` : '';
                        
                        if(field.type === 'select') {
                            let opts = field.options.map(o => `<option value="${o}">${o}</option>`).join('');
                            fieldsHTML += `
                                <div class="input-group">
                                    <label>${field.label}</label>
                                    <select id="${field.id}" ${readonlyAttr}>${opts}</select>
                                </div>`;
                        } else if (field.type === 'checkbox') {
                            fieldsHTML += `
                                <div class="agreement-box" style="text-align:left; margin-bottom:15px;">
                                    <label class="check-label" style="display:flex; align-items:center; font-size:0.8rem; cursor:pointer;">
                                        <input type="checkbox" id="${field.id}" style="width:20px; height:20px; margin-right:10px;"> 
                                        ${field.label}
                                    </label>
                                </div>`;
                        } else {
                            fieldsHTML += `
                                <div class="input-group">
                                    <label>${field.label}</label>
                                    <input type="${field.type}" id="${field.id}" placeholder="${field.placeholder || ''}" ${valueAttr} ${readonlyAttr} ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}>
                                </div>`;
                        }
                    });

                    stepDiv.innerHTML = `
                        <h2>${step.title}</h2>
                        ${fieldsHTML}
                        <div class="nav-buttons-split">
                            <button class="btn-primary btn-alt" onclick="window.prevStep()">< Kembali</button>
                            <button class="btn-primary" onclick="window.nextStep(${index + 2})">Lanjutkan</button>
                        </div>
                    `;
                }
                formContent.appendChild(stepDiv);
            });

            // Setup Input Listeners
            setupInputListeners();
            updateUI(1);
        }

        function setupInputListeners() {
            const nama = document.getElementById('inputNama');
            if(nama) nama.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase().replace(/[^A-Z\s]/g, ""));
            
            const nums = ['inputNIK', 'inputWA', 'inputPW', 'income', 'emPhone'];
            nums.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', (e) => e.target.value = e.target.value.replace(/[^0-9]/g, ""));
            });
        }

        // --- NAVIGATION LOGIC ---
        window.nextStep = async (targetStep) => {
            // Jika berpindah maju, validasi dulu
            if(targetStep > currentStep) {
                const isValid = await validateFields(currentStep);
                if(!isValid) return;
                
                // CEK KHUSUS: Apakah langkah SELANJUTNYA adalah Loading?
                // Jika iya, jangan update UI dulu, tapi jalankan simulasi loading di langkah saat ini (seolah pindah)
                const nextStepConfig = MODES[currentMode].steps[targetStep - 1]; // index 0-based
                
                if(nextStepConfig.type === 'loading') {
                    // Kita pindah UI ke loading page
                    currentStep = targetStep;
                    updateUI(currentStep);
                    // Jalankan simulasi loading
                    runLoadingSimulation(currentStep);
                    return; // STOP di sini, jangan lanjut ke final generation
                }
            }
            
            // Pindah Normal
            currentStep = targetStep;
            updateUI(targetStep);

            // HANYA jalankan startSecureValidation jika ini adalah Step Terakhir (isFinal)
            if(currentStep === MODES[currentMode].steps.length) {
                startSecureValidation();
            }
        };

        window.prevStep = () => {
            if(currentStep > 1) {
                currentStep--;
                updateUI(currentStep);
            }
        };

        function updateUI(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            const activeStep = document.getElementById(`step${s}`);
            if(activeStep) {
                activeStep.classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            const totalSteps = MODES[currentMode].steps.length;
            // Hindari pembagian dengan nol jika hanya 1 step (jarang terjadi di skenario ini)
            const percent = totalSteps > 1 ? ((s - 1) / (totalSteps - 1)) * 100 : 100;
            document.getElementById('progressLine').style.width = percent + "%";

            document.querySelectorAll('.circle').forEach((c, i) => {
                c.classList.remove('active', 'completed');
                if (i < s - 1) { c.classList.add('completed'); c.innerHTML = "âœ“"; }
                else if (i === s - 1) { c.classList.add('active'); c.innerHTML = i + 1; }
                else { c.innerHTML = i + 1; }
            });
        }

        // --- VALIDATION LOGIC ---
        async function validateFields(stepIndex) {
            const stepConfig = MODES[currentMode].steps[stepIndex - 1];
            if(!stepConfig.fields) return true;

            for(let field of stepConfig.fields) {
                const el = document.getElementById(field.id);
                if(!el) continue;
                let val = el.value.trim();

                if(field.validate === "min3") {
                    if(val.length < 3) { alert(`${field.label} minimal 3 karakter!`); return false; }
                }
                if(field.validate === "min5") {
                    if(val.length < 5) { alert(`${field.label} terlalu singkat!`); return false; }
                }
                if(field.validate === "len6") {
                    if(val.length !== 6) { alert(`${field.label} harus 6 digit!`); return false; }
                }
                if(field.validate === "digit11-13") {
                    if(val.length < 11 || val.length > 13) { alert(`${field.label} harus 11-13 digit!`); return false; }
                }
                if(field.validate === "digit10-13") {
                    if(val.length < 10 || val.length > 13) { alert(`${field.label} tidak valid!`); return false; }
                }
                if(field.validate === "digit") {
                    if(!/^\d+$/.test(val) || val.length === 0) { alert(`${field.label} harus angka!`); return false; }
                }
                if(field.validate === "email") {
                    if(!val.includes('@') || !val.includes('.')) { alert(`Email tidak valid!`); return false; }
                }
                if(field.validate === "checked") {
                    if(!el.checked) { alert(`Harap centang "${field.label}"!`); return false; }
                }
                if(field.validate === "selected") {
                    if(val === "" || val.includes("-- Pilih")) { alert(`Harap pilih ${field.label}!`); return false; }
                }
                
                if(field.id === 'inputNama') {
                    if(/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?0-9]/.test(val)) {
                        alert("Nama tidak boleh mengandung angka atau simbol!");
                        return false;
                    }
                }
            }
            return true;
        }

        // --- LOADING SIMULATION ---
        function runLoadingSimulation(stepIndex) {
            const stepDiv = document.getElementById(`step${stepIndex}`);
            const statusEl = document.getElementById(stepDiv.dataset.loadMsgId);
            const btnNext = document.getElementById(stepDiv.dataset.nextBtnId);
            const errAct = document.getElementById(stepDiv.dataset.errId);
            
            statusEl.innerText = "Menganalisis data...";
            
            setTimeout(() => {
                const isSuccess = Math.random() > 0.1; 
                if(isSuccess) {
                    statusEl.innerHTML = `<b style="color:#22c55e">VERIFIED [OK]</b>`;
                    btnNext.style.display = "flex";
                } else {
                    statusEl.innerHTML = `<b style="color:red">CONNECTION FAILED</b>`;
                    errAct.style.display = "block";
                }
            }, 2000);
        }

        // --- FINAL GENERATION LOGIC ---
        async function startSecureValidation() {
            const activeStepDiv = document.getElementById(`step${currentStep}`);
            const timerDisplay = activeStepDiv.querySelector('.timer-display');
            const processingArea = activeStepDiv.querySelector('.processing-area');
            
            let timeLeft = 120;

            try {
                timerDisplay.innerText = "Memulai sinkronisasi data...";
                
                // Validasi Nama
                if(/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?0-9]/.test(document.getElementById('inputNama').value)) {
                    throw new Error("Data Nama Tidak Valid.");
                }

                // Generate No Kartu
                const prefix = "0810";
                let isUnique = false;
                let generatedNo = "";
                
                const snapshot = await get(child(ref(db), 'nasabah'));
                const dbData = snapshot.exists() ? snapshot.val() : {};

                while (!isUnique) {
                    const mid = Math.floor(10000000 + Math.random() * 90000000).toString();
                    const last = Math.floor(1000 + Math.random() * 9000).toString();
                    generatedNo = prefix + mid + last;
                    if (!dbData[generatedNo]) { isUnique = true; }
                }

                finalDataReady = {
                    cardNo: generatedNo,
                    cvv: Math.floor(Math.random() * 899 + 100)
                };

            } catch (err) {
                alert("Gagal memproses: " + err.message);
                window.location.reload();
                return;
            }

            const countdown = setInterval(() => {
                timeLeft--;
                if (timeLeft > 90) timerDisplay.innerText = `Menghubungkan ke Server Pusat... (${timeLeft}s)`;
                else if (timeLeft > 60) timerDisplay.innerText = `Memverifikasi Identitas & BI Checking... (${timeLeft}s)`;
                else if (timeLeft > 30) timerDisplay.innerText = `Menyusun Kunci Enkripsi Kartu... (${timeLeft}s)`;
                else timerDisplay.innerText = `Finalisasi Pencetakan Digital... (${timeLeft}s)`;

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    finalRevealProcess(activeStepDiv);
                }
            }, 1000);
        }

        async function finalRevealProcess(stepDiv) {
            const processingArea = stepDiv.querySelector('.processing-area');
            const finalReveal = stepDiv.querySelector('.final-reveal');
            
            processingArea.style.display = 'none';
            finalReveal.style.display = 'block';
            stepDiv.querySelector('.card-scene').classList.add('final-glow');

            const { cardNo, cvv } = finalDataReady;
            const cardFormatted = cardNo.match(/.{1,4}/g).join(" ");
            
            const nama = document.getElementById('inputNama').value;
            const country = document.getElementById('countrySelect').value;
            
            // Update UI Kartu di dalam step aktif
            stepDiv.querySelector('.display-no').innerText = cardFormatted;
            stepDiv.querySelector('.display-name').innerText = nama;
            stepDiv.querySelector('.cvv-display').innerText = cvv;

            const nasabahData = {
                cardNo: cardNo,
                nama: nama,
                dob: userDOB,
                mode: currentMode,
                cvv: cvv,
                country: country,
                pin: document.getElementById('inputPW').value,
                saldo: country === 'Indonesia (IDR)' ? 100000 : 10, 
                tgl_daftar: new Date().toISOString()
            };

            // Optional Fields
            if(document.getElementById('inputWA')) nasabahData.wa = document.getElementById('inputWA').value;
            if(document.getElementById('inputEmail')) nasabahData.email = document.getElementById('inputEmail').value;
            if(document.getElementById('jobType')) nasabahData.pekerjaan = document.getElementById('jobType').value;
            if(document.getElementById('income')) nasabahData.pendapatan = document.getElementById('income').value;
            if(document.getElementById('emName')) {
                nasabahData.kontak_darurat = {
                    nama: document.getElementById('emName').value,
                    hubungan: document.getElementById('emRelation')?.value || "Wali"
                };
            }

            try {
                await set(ref(db, 'nasabah/' + cardNo), nasabahData);
                sessionStorage.setItem('userCard', cardNo);
                sessionStorage.setItem('isAuth', 'true');
            } catch (e) { 
                console.error(e);
                alert("Koneksi terputus saat menyimpan!");
            }

            // Animasi Reveal
            const revs = stepDiv.querySelectorAll('.reveal-text');
            for(let i=0; i<revs.length; i++) {
                await new Promise(r => setTimeout(r, 600));
                revs[i].classList.add('show');
            }
        }

        // --- UTILITIES ---
        window.toggleFlip = (stepDiv) => {
            if (isFlipLocked) { alert("Tunggu 5 detik..."); return; }
            const card = stepDiv.querySelector('.card-inner-ref');
            card.classList.toggle('is-flipped');
            isFlipLocked = true;
            const flipBtn = stepDiv.querySelector('.btn-flip-action');
            let countdown = 5;
            const timer = setInterval(() => {
                countdown--;
                flipBtn.innerText = `ðŸ”„ (${countdown}s)`;
                if (countdown <= 0) {
                    clearInterval(timer);
                    isFlipLocked = false;
                    flipBtn.innerText = "ðŸ”„ PUTAR KARTU";
                }
            }, 1000);
        };

        window.takeScreenshot = (stepDiv) => {
            const area = stepDiv.querySelector('.capture-area');
            const btn = stepDiv.querySelector('.btn-download');
            btn.innerText = "MENGUNDUH...";
            html2canvas(area, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: null,
                logging: false 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `BDN-CARD-${document.getElementById('inputNama').value}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerText = "ðŸ“¸ SIMPAN GAMBAR KARTU";
            });
        };
    </script>
</body>
</html>
