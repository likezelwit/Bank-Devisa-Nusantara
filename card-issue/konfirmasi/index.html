<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otorisasi PIN | BDN</title>
    <style>
        :root { --gold: #b5985a; --dark: #1e293b; }
        body { margin: 0; background: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .card-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .confirm-box { width: 100%; max-width: 400px; background: white; padding: 2rem; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center; }
        .pin-display { display: flex; justify-content: center; gap: 12px; margin: 2rem 0; }
        .dot { width: 16px; height: 16px; border: 2px solid #cbd5e1; border-radius: 50%; transition: 0.2s; }
        .dot.active { background: var(--gold); border-color: var(--gold); transform: scale(1.2); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 300px; margin: 0 auto; }
        .numpad button { aspect-ratio: 1/1; border-radius: 50%; border: 1px solid #e2e8f0; background: white; font-size: 1.5rem; font-weight: 700; cursor: pointer; }
        #submitBtn { background: var(--dark) !important; color: white !important; }
    </style>
</head>
<body>
    <main class="card-container">
        <div class="confirm-box">
            <header>
                <h1 style="font-size: 1.8rem;">Otorisasi PIN</h1>
                <p>Konfirmasi transaksi <br><span style="color:var(--gold); font-weight:800;" id="confPrice">$0</span></p>
            </header>

            <div class="pin-display">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            
            <div class="numpad">
                <button class="num-btn" data-val="1">1</button><button class="num-btn" data-val="2">2</button><button class="num-btn" data-val="3">3</button>
                <button class="num-btn" data-val="4">4</button><button class="num-btn" data-val="5">5</button><button class="num-btn" data-val="6">6</button>
                <button class="num-btn" data-val="7">7</button><button class="num-btn" data-val="8">8</button><button class="num-btn" data-val="9">9</button>
                <button id="delBtn">DEL</button><button class="num-btn" data-val="0">0</button><button id="submitBtn">OK</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXYDqFmhO8nacuX-hVnNsXMmpeqwYlW7U",
            authDomain: "wifist-d3588.firebaseapp.com",
            databaseURL: "https://wifist-d3588-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            projectId: "wifist-d3588",
            storageBucket: "wifist-d3588.firebasestorage.app",
            messagingSenderId: "460842291436",
            appId: "1:460842291436:web:f82e6f0c7fc668fc72d5c9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const harga = parseInt(sessionStorage.getItem('selected_price'));
        const variant = sessionStorage.getItem('selected_variant');
        document.getElementById('confPrice').innerText = "$" + harga.toLocaleString();

        let inputPin = "";
        const dots = document.querySelectorAll('.dot');

        document.querySelectorAll('.num-btn').forEach(b => {
            b.onclick = () => { if(inputPin.length < 6) { inputPin += b.dataset.val; updateDots(); } }
        });

        document.getElementById('delBtn').onclick = () => { inputPin = inputPin.slice(0, -1); updateDots(); }

        function updateDots() { dots.forEach((d, i) => d.classList.toggle('active', i < inputPin.length)); }

        document.getElementById('submitBtn').onclick = async () => {
            const pinBenar = sessionStorage.getItem('pending_pin');
            const saldo = parseFloat(sessionStorage.getItem('pending_saldo'));
            const cardNum = sessionStorage.getItem('pending_card');

            if(inputPin !== pinBenar) return alert("PIN SALAH!");
            if(saldo < harga) return alert("SALDO TIDAK CUKUP!");

            try {
                const updates = {};
                updates[`nasabah/${cardNum}/saldo`] = saldo - harga;
                updates[`nasabah/${cardNum}/cardStatus`] = "Active";
                updates[`nasabah/${cardNum}/activeVariant`] = variant;
                
                await update(ref(db), updates);
                localStorage.setItem('nomorKartu', cardNum); // Kunci di index
                window.location.href = '../success/';
            } catch (e) { alert("Gagal proses!"); }
        };
    </script>
</body>
</html>
