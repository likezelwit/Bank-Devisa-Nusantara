<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BANK DEVISA - SPA</title>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- LIBRARY EKSTERNAL (QR Code & Scanner & HTML2Canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --accent: #b8924e; --dark: #0f172a; --light-bg: #f8fafc; --nav-height: 80px; --success: #22c55e; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--light-bg); 
            color: var(--dark); 
            margin: 0; 
            padding: 0; 
            padding-bottom: calc(var(--nav-height) + 20px);
            overflow-x: hidden; 
        }
        
        .container { max-width: 600px; margin: auto; padding: 20px; box-sizing: border-box; }
        
        /* SPA UTILS */
        .spa-page { display: none; animation: fadeIn 0.3s ease-in-out; padding-bottom: 20px; }
        .spa-page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .logo { font-weight: 800; cursor:pointer; font-size: 1.2rem; }
        .logo span { color: var(--accent); }

        /* BALANCE CARD */
        .balance-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 25px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(15,23,42,0.15);
            display: flex; flex-direction: column;
        }
        .saldo-wrapper { display: flex; align-items: baseline; gap: 8px; margin: 8px 0; width: 100%; min-width: 0; flex: 1; }
        .currency-label { font-size: 1rem; font-weight: 600; opacity: 0.8; flex-shrink: 0; }
        #saldoNasabah { font-size: 2.2rem; color: var(--accent); margin: 0; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; transition: font-size 0.2s ease; line-height: 1; }
        .card-info-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .user-info { min-width: 0; flex: 1; margin-right: 10px; }
        .user-info p { margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* MENU GRID */
        .section-title { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 25px 0 15px 5px; color: #94a3b8; }
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .feature-card {
            background: white; padding: 15px 5px; border-radius: 16px; text-align: center;
            border:1px solid #e2e8f0; cursor: pointer; transition: all 0.2s ease;
            color: inherit; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
        }
        .feature-card:active { transform: scale(0.95); background: #f8fafc; }
        .feature-card svg { width: 28px; height: 28px; stroke: var(--dark); stroke-width: 2; fill: none; }
        .feature-card h3 { font-size: 0.65rem; margin: 0; font-weight: 700; color: var(--dark); }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e2e8f0;
            padding: 10px 20px 25px 20px;
            display: flex; justify-content: space-between; align-items: flex-end;
            z-index: 100;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.7rem; font-weight: 600; cursor: pointer; width: 60px; text-decoration: none; }
        .nav-item.active { color: var(--accent); }
        .nav-item svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; margin-bottom: 4px; }

        /* QR FLOAT BUTTON */
        .qr-float {
            position: absolute; left: 50%; top: -30px; transform: translateX(-50%);
            width: 70px; height: 70px; background: var(--dark); border-radius: 20px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.3);
            border: 4px solid var(--light-bg); cursor: pointer; transition: transform 0.2s;
        }
        .qr-float:active { transform: translateX(-50%) scale(0.95); }
        .qr-float svg { width: 32px; height: 32px; stroke: var(--accent); stroke-width: 2; fill: none; }

        /* INFO CARDS */
        .info-card { background: white; padding: 20px; border-radius: 20px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .detail-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { background: white; border: 1px solid #e2e8f0; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* HISTORY LIST */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .history-item:last-child { border-bottom: none; }
        .hist-icon { width: 40px; height: 40px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .hist-icon svg { width: 20px; height: 20px; stroke: var(--dark); stroke-width: 2; }
        .hist-details { flex: 1; }
        .hist-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 4px; color: var(--dark); }
        .hist-date { font-size: 0.7rem; color: #94a3b8; }
        .hist-amount { font-weight: 800; font-size: 0.9rem; }
        .amount-minus { color: var(--dark); }
        .amount-plus { color: var(--success); }

        /* TRANSFER PAGE STYLES */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
        .input-wrapper input { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; font-family: inherit; font-size: 1.1rem; font-weight: 700; box-sizing: border-box; outline: none; }
        .input-wrapper input:focus { border-color: var(--accent); }
        #boxPenerima { display: none; background: #f1f5f9; padding: 15px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid var(--accent); }
        .btn-main { width: 100%; padding: 18px; border-radius: 15px; border: none; background: var(--dark); color: white; font-weight: 800; font-size: 1rem; cursor: pointer; }
        .btn-main:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* TOPUP & PIN STYLES */
        .denom-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .denom-item { padding: 15px; border: 1px solid #e2e8f0; border-radius: 15px; text-align: center; cursor: pointer; background: white; }
        .denom-item.selected { border-color: var(--accent); background: #fefcf8; box-shadow: 0 0 0 2px var(--accent); }
        .pin-dots { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; margin-top: 20px; }
        .dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid #cbd5e1; }
        .dot.active { background: var(--dark); border-color: var(--dark); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .num-btn { padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; background: white; font-size: 1.2rem; font-weight: 800; cursor: pointer; }

        /* QR SCAN STYLES */
        #reader { width: 100%; border-radius: 20px; overflow: hidden; margin-bottom: 20px; background: #000; min-height: 250px; }
        .receipt { background: #f1f5f9; padding: 20px; border-radius: 20px; text-align: left; margin: 20px 0; border: 2px dashed #cbd5e1; }
        
        /* QR PAY STYLES */
        .card-qr { background: white; color: var(--dark); padding: 30px; border-radius: 30px; width: 85%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); margin: 20px auto; animation: fadeIn 0.5s ease; }
        .qr-frame { margin: 20px auto; padding: 15px; border: 2px solid #f1f5f9; border-radius: 20px; display: inline-block; background: white; }
        #qrcode { width: 220px; height: 220px; }

        /* SETTINGS STYLES */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #f1f5f9; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e2e8f0; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #16a34a; }
        input:checked + .slider:before { transform: translateX(24px); }

        /* LOADER */
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- SECURITY CHECK -->
    <script>
        if(!localStorage.getItem('userCard')) {
            // Jika tidak login, redirect ke file login asumsi (index.html di luar folder jika ada)
            // Karena ini SPA tunggal, kita asumsikan jika reload harus ada session.
            // alert("Silakan Login Terlebih Dahulu"); 
            // window.location.href = './login.html'; // Sesuaikan dengan file login kamu
        }
    </script>

    <div class="container">
        
        <!-- HEADER -->
        <header>
            <div class="logo" onclick="openSPA('main-dashboard')">BANK<span>DEVISA</span></div>
            <button id="btnLogout" style="padding: 6px 12px; border-radius: 8px; border: 1px solid #fee2e2; background: #fff1f1; cursor: pointer; font-weight: 700; color: #ef4444; font-size: 0.7rem;">
                Keluar
            </button>
        </header>

        <!-- 1. MAIN DASHBOARD -->
        <div id="main-dashboard" class="spa-page active">
            <div class="balance-card">
                <p style="opacity: 0.6; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase;">Total Saldo</p>
                <div class="saldo-wrapper">
                    <span class="currency-label" id="currencyLabel">IDR</span>
                    <h2 id="saldoNasabah">Memuat...</h2>
                </div>
                <div class="card-info-bottom">
                    <div class="user-info">
                        <p id="namaNasabah" style="font-size: 0.9rem; font-weight: 700;">Memuat...</p>
                        <p id="nomorKartu" style="font-size: 0.75rem; opacity: 0.7; margin: 2px 0 0;">**** **** ****</p>
                    </div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1280px-Mastercard-logo.svg.png" width="40" alt="Mastercard">
                </div>
            </div>

            <div class="section-title">Layanan Utama</div>
            <div class="menu-grid">
                <!-- Transfer -->
                <div onclick="openSPA('page-transfer')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 3.5a1.5 1.5 0 01-3 0 1.5 1.5 0 013 0zm6-6a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM7 17.5v2m0-2v-2.5M10.5 14h5m-5 0a2.5 2.5 0 114.956 0M17 20.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM14 11.5v6m0-6V14m0 0a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" /></svg>
                    <h3>Transfer</h3>
                </div>
                <!-- Top Up -->
                <div onclick="openSPA('page-topup')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                    <h3>Top Up</h3>
                </div>
                <!-- Payment / Tagihan (Map ke Topup dulu) -->
                <div onclick="openSPA('page-topup')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                    <h3>Tagihan</h3>
                </div>
                <!-- QRIS -->
                <div onclick="openSPA('page-qrpay')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                    <h3>QRIS</h3>
                </div>
            </div>

            <div class="section-title">Investasi & Pinjaman</div>
            <div class="menu-grid">
                <div onclick="alert('Fitur Investasi Segera Hadir')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg><h3>Reksa</h3>
                </div>
                <div onclick="alert('Fitur Emas Segera Hadir')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg><h3>Emas</h3>
                </div>
                <div onclick="alert('Fitur Pinjaman Segera Hadir')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3>Pinjaman</h3>
                </div>
                 <!-- SETTINGS BUTTON DI MENU GRID UNTUK AKSES MUDAH -->
                <div onclick="openSPA('page-settings')" class="feature-card">
                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><h3>Setelan</h3>
                </div>
            </div>
        </div>

        <!-- 2. PAGE RIWAYAT -->
        <div id="page-history" class="spa-page">
            <div class="detail-header">
                <button class="back-btn" onclick="openSPA('main-dashboard')">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 style="font-size: 1.2rem; margin: 0;">Riwayat Transaksi</h2>
            </div>
            <div class="info-card" id="historyList">
                <div style="text-align:center; padding:20px; color:#94a3b8;">Memuat riwayat...</div>
            </div>
        </div>

        <!-- 3. PAGE TRANSFER -->
        <div id="page-transfer" class="spa-page">
            <div class="detail-header">
                <button class="back-btn" onclick="openSPA('main-dashboard')">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 style="font-size: 1.2rem; margin: 0;">M-Transfer</h2>
            </div>

            <div class="info-card">
                <div class="input-group">
                    <label>Nomor Rekening Tujuan</label>
                    <input type="number" id="tf-targetCard" placeholder="Masukkan nomor kartu" style="width:100%; padding: 15px; border-radius:15px; border:1px solid #e2e8f0;">
                </div>
                <div id="tf-boxPenerima" style="display:none; background: #f1f5f9; padding: 15px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid var(--accent);">
                    <p style="margin:0; font-size:0.65rem; color:#64748b; font-weight:700;">PENERIMA TERVERIFIKASI</p>
                    <p style="margin:5px 0 0; font-size:1.1rem; font-weight:800; color:var(--dark);">
                        <span id="tf-namaPenerima"></span>
                        <span id="tf-flagPenerima" style="font-size:0.6rem; padding:2px 8px; border-radius:5px; background:var(--dark); color:white; margin-left:10px;"></span>
                    </p>
                </div>
                <div class="input-group">
                    <label>Nominal Transfer</label>
                    <input type="text" id="tf-amountDisplay" placeholder="0" autocomplete="off" style="width:100%; padding: 15px; border-radius:15px; border:1px solid #e2e8f0;">
                </div>
                <div id="tf-currencyPreview" style="display:none; background:#fffbeb; border:1px dashed var(--accent); padding:12px; border-radius:12px; margin-bottom:20px; text-align:center;">
                    <p style="margin:0 0 5px; font-size:0.65rem; color:#92400e; font-weight:700; text-transform:uppercase;">Konversi Mata Uang</p>
                    <div id="tf-convertedVal" style="font-weight:800; color:#92400e; font-size:1.1rem;"></div>
                </div>
                <button id="tf-btnProses" class="btn-main" disabled>Kirim Sekarang</button>
            </div>
        </div>

        <!-- 4. PAGE TOPUP -->
        <div id="page-topup" class="spa-page">
            <div class="detail-header">
                <button class="back-btn" onclick="openSPA('main-dashboard')">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 style="font-size: 1.2rem; margin: 0;">Tambah Saldo</h2>
            </div>

            <!-- STEP 1: INPUT -->
            <div id="tu-step1" class="info-card">
                <div class="input-group">
                    <label>Jumlah Nominal (IDR)</label>
                    <input type="text" id="tu-customAmount" placeholder="0" autocomplete="off" style="width:100%; padding: 18px; border-radius:15px; border:1px solid #e2e8f0; font-size:1.2rem; font-weight:800;">
                </div>
                <div class="denom-grid">
                    <div class="denom-item" onclick="setTopupAmount(50000)"><h4>50.000</h4></div>
                    <div class="denom-item" onclick="setTopupAmount(100000)"><h4>100.000</h4></div>
                    <div class="denom-item" onclick="setTopupAmount(500000)"><h4>500.000</h4></div>
                    <div class="denom-item" onclick="setTopupAmount(1000000)"><h4>1.000.000</h4></div>
                </div>
                <button onclick="goToTopupPin()" class="btn-main">Lanjutkan</button>
            </div>

            <!-- STEP 2: PIN -->
            <div id="tu-step2" class="info-card hidden" style="text-align:center;">
                <h3 style="margin-bottom:5px;">Konfirmasi PIN</h3>
                <p style="color:#64748b; font-size:0.8rem;">Keamanan Transaksi</p>
                <div class="pin-dots" id="tu-pinDots">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
                <div class="numpad">
                    <button class="num-btn" onclick="pressTopupNum(1)">1</button>
                    <button class="num-btn" onclick="pressTopupNum(2)">2</button>
                    <button class="num-btn" onclick="pressTopupNum(3)">3</button>
                    <button class="num-btn" onclick="pressTopupNum(4)">4</button>
                    <button class="num-btn" onclick="pressTopupNum(5)">5</button>
                    <button class="num-btn" onclick="pressTopupNum(6)">6</button>
                    <button class="num-btn" onclick="pressTopupNum(7)">7</button>
                    <button class="num-btn" onclick="pressTopupNum(8)">8</button>
                    <button class="num-btn" onclick="pressTopupNum(9)">9</button>
                    <button class="num-btn" style="color:#ef4444" onclick="clearTopupPin()">C</button>
                    <button class="num-btn" onclick="pressTopupNum(0)">0</button>
                    <button class="num-btn" onclick="backspaceTopup()">‚å´</button>
                </div>
            </div>

            <!-- STEP 3: LOADING -->
            <div id="tu-step3" class="info-card hidden" style="text-align:center; padding:40px;">
                <div class="spinner"></div>
                <p style="font-weight:700; margin-top:20px; color:#64748b;">Menambahkan Saldo...</p>
            </div>

            <!-- STEP 4: SUCCESS -->
            <div id="tu-step4" class="info-card hidden" style="text-align:center;">
                <div style="background:#f0fdf4; width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                    <span style="font-size:2.5rem;">‚úÖ</span>
                </div>
                <h2 style="margin:0; color:var(--dark);">Top Up Sukses</h2>
                <p style="color:#64748b; font-size:0.8rem; margin-top:5px;">Saldo telah ditambahkan</p>
                <div style="background:#f8fafc; padding:20px; border-radius:15px; margin-top:25px; text-align:left;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:#64748b;">Nominal</span>
                        <b id="tu-resPrice" style="color:#16a34a;">+ Rp 0</b>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:#64748b;">Metode</span>
                        <b style="color:var(--dark);">Self Top-Up</b>
                    </div>
                </div>
                <button onclick="openSPA('main-dashboard'); initDashboard();" class="btn-main" style="margin-top:30px;">Kembali ke Beranda</button>
            </div>
        </div>

        <!-- 5. PAGE QR SCAN -->
        <div id="page-qrscan" class="spa-page">
            <div class="detail-header">
                <button class="back-btn" onclick="closeScanner(); openSPA('main-dashboard')">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 style="font-size: 1.2rem; margin: 0;">Scan QR</h2>
            </div>

            <!-- STEP 1: SCAN -->
            <div id="qs-step1" class="info-card">
                <p style="text-align:center; font-size:0.85rem; color:#64748b; margin-bottom:20px;">Arahkan kamera ke kode QR tujuan</p>
                <div id="reader"></div>
                <button class="btn-main" style="background:#ef4444;" onclick="closeScanner(); openSPA('main-dashboard')">BATAL</button>
            </div>

            <!-- STEP 2: INPUT NOMINAL -->
            <div id="qs-step2" class="info-card hidden" style="text-align:center;">
                <div style="font-size:4rem;">üë§</div>
                <h2 id="qs-targetName" style="margin:10px 0 5px 0;">---</h2>
                <p id="qs-targetCard" style="margin:0; color:#64748b; font-size:0.9rem; font-weight:600;">Rekening: ---</p>
                <hr style="margin:20px 0; border:none; border-top:1px solid #e2e8f0;">
                <input type="number" id="qs-amount" placeholder="Masukkan Nominal" style="width:100%; padding:15px; border-radius:15px; border:1px solid #e2e8f0; font-size:1.2rem; font-weight:800; text-align:center;">
                <button onclick="goToQrPin()" class="btn-main" style="margin-top:15px;">LANJUTKAN</button>
            </div>

            <!-- STEP 3: PIN -->
            <div id="qs-step3" class="info-card hidden" style="text-align:center;">
                <h3>Konfirmasi PIN</h3>
                <p style="font-size:0.85rem; color:#64748b;">Masukkan 6 digit PIN</p>
                <div class="pin-dots" id="qs-pinDots">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
            </div>

            <!-- STEP 4: FINAL -->
            <div id="qs-step4" class="info-card hidden">
                <div id="qs-loader" style="text-align:center;">
                    <div class="spinner"></div>
                    <p style="font-weight:600;">Sedang Memproses...</p>
                </div>
                <div id="qs-success" style="display:none; text-align:center;">
                    <div style="font-size:4rem;">‚úÖ</div>
                    <h2 style="margin:10px 0;">Transfer Berhasil</h2>
                    <div class="receipt" id="strukPrint">
                        <h4>Penerima</h4>
                        <p id="qs-resName" style="margin:5px 0 15px 0; font-weight:800; font-size:1.1rem;"></p>
                        <h4>Nominal</h4>
                        <p id="qs-resAmt" style="margin:0; color:var(--accent); font-size:1.4rem;"></p>
                        <div style="font-size:0.65rem; color:#94a3b8; text-align:center; margin-top:10px;">Bank Devisa Nusantara</div>
                    </div>
                    <button class="btn-main" style="background:var(--success);" onclick="downloadQrStruk()">SIMPAN STRUK</button>
                    <button class="btn-main" style="background:transparent; color:var(--dark); border:2px solid var(--dark); margin-top:10px;" onclick="openSPA('main-dashboard'); initDashboard();">SELESAI</button>
                </div>
            </div>
        </div>

        <!-- 6. PAGE QR PAY -->
        <div id="page-qrpay" class="spa-page">
            <div class="detail-header">
                <button class="back-btn" onclick="openSPA('main-dashboard')">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 style="font-size: 1.2rem; margin: 0;">QR Saya</h2>
            </div>
            
            <div id="qp-viewInactive" class="card-qr hidden">
                <h1 style="font-size:4rem; margin:0;">üö´</h1>
                <h3>Layanan Belum Aktif</h3>
                <p style="color:#64748b; font-size:0.85rem;">Aktifkan fitur QR-Pay di menu Setelan.</p>
                <button class="btn-main" onclick="openSPA('page-settings')">BUKA SETELAN</button>
            </div>

            <div id="qp-viewVerify" class="card-qr hidden">
                <div style="font-size:2.5rem;">üîê</div>
                <h3>Verifikasi Kunci</h3>
                <p style="color:#64748b; font-size:0.8rem;">Masukkan CodeQR untuk generate.</p>
                <input type="password" id="qp-inputCode" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" style="width:100%; padding:15px; border-radius:12px; border:2px solid #e2e8f0; margin-top:15px; text-align:center;">
                <button class="btn-main" id="qp-btnVerify" style="margin-top:20px;">VERIFIKASI</button>
            </div>

            <div id="qp-viewQR" class="card-qr hidden">
                <p style="font-weight:800; font-size:0.65rem; color:var(--accent); text-transform:uppercase;">My Payment Token</p>
                <div class="qr-frame"><div id="qrcode"></div></div>
                <h4 id="qp-userName" style="margin:10px 0 5px; text-transform:uppercase;">---</h4>
                <div style="background:#f8fafc; padding:12px; border-radius:12px; margin-bottom:10px;">
                    <p id="qp-userCardDisplay" style="margin:0; font-size:0.9rem; font-weight:700; letter-spacing:1.5px;">****</p>
                </div>
                <p style="font-size:0.65rem; color:#94a3b8;">Token ini berubah berkala.</p>
                <button class="btn-main" style="background:var(--dark);" onclick="openSPA('main-dashboard')">TUTUP</button>
            </div>
        </div>

        <!-- 7. PAGE SETTINGS -->
        <div id="page-settings" class="spa-page">
            <div class="detail-header">
                <button class="back-btn" onclick="openSPA('main-dashboard')">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 style="font-weight:800; color:var(--dark); margin:0;">Pengaturan</h2>
            </div>

            <div class="info-card">
                <div class="setting-item">
                    <div>
                        <h4 style="margin:0; font-size:0.95rem;">Izinkan Pembayaran QR-Pay</h4>
                        <p style="margin:5px 0 0; font-size:0.75rem; color:#64748b;">Aktifkan fitur terima pembayaran via QR</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="set-switchQR" onchange="toggleQRSetting()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <h4 style="margin:0; font-size:0.95rem;">Akun Business</h4>
                        <p style="margin:5px 0 0; font-size:0.75rem; color:#64748b;">Fitur khusus toko dan UMKM</p>
                    </div>
                    <label class="switch"><input type="checkbox" disabled><span class="slider"></span></label>
                </div>
                 <div class="setting-item">
                    <div>
                        <h4 style="margin:0; font-size:0.95rem; color:#ef4444;">Bekukan Akun</h4>
                        <p style="margin:5px 0 0; font-size:0.75rem; color:#64748b;">Nonaktifkan kartu sementara</p>
                    </div>
                    <label class="switch"><input type="checkbox" disabled><span class="slider"></span></label>
                </div>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="openSPA('page-history')">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Riwayat</span>
        </div>
        <div class="nav-item" onclick="openSPA('main-dashboard')">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            <span>Akun</span>
        </div>
        
        <!-- QR FLOAT BUTTON -->
        <div class="qr-float" onclick="openSPA('page-qrscan')">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
        </div>

        <div class="nav-item active" onclick="openSPA('main-dashboard')">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
            <span>Home</span>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXYDqFmhO8nacuX-hVnNsXMmpeqwYlW7U",
            databaseURL: "https://wifist-d3588-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "wifist-d3588"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GLOBAL VARIABLES
        const myCard = localStorage.getItem('userCard');
        let html5QrCode = null; // Untuk Scanner
        let globalUserData = null; // Cache user data

        // === 1. SPA NAVIGATION LOGIC ===
        window.openSPA = (pageId) => {
            // Stop Scanner jika sedang jalan dan pindah page
            if(pageId !== 'page-qrscan' && html5QrCode) {
                closeScanner();
            }

            // Hide all pages
            document.querySelectorAll('.spa-page').forEach(page => page.classList.remove('active'));
            
            // Show target
            const target = document.getElementById(pageId);
            if(target) {
                target.classList.add('active');
                window.scrollTo(0,0);
            }

            // Logic spesifik per page saat dibuka
            if(pageId === 'page-qrscan') {
                // Reset view scan
                document.getElementById('qs-step1').classList.remove('hidden');
                document.getElementById('qs-step2').classList.add('hidden');
                document.getElementById('qs-step3').classList.add('hidden');
                document.getElementById('qs-step4').classList.add('hidden');
                document.getElementById('qs-success').style.display = 'none';
                document.getElementById('qs-loader').style.display = 'block';
                
                // Start Camera with slight delay
                setTimeout(initScanner, 500);
            }
            else if(pageId === 'page-qrpay') {
                initQrPay();
            }
            else if(pageId === 'page-settings') {
                initSettings();
            }
            else if(pageId === 'page-topup') {
                resetTopup();
            }
            else if(pageId === 'main-dashboard') {
                initDashboard();
            }
        };

        // === 2. DASHBOARD LOGIC ===
        async function initDashboard() {
            if(!myCard) return;
            try {
                const snap = await get(child(ref(db), `nasabah/${myCard}`));
                if(snap.exists()) {
                    const data = snap.val();
                    globalUserData = data; // Cache data

                    if (data.MyAccount !== "active") { window.location.reload(); return; }

                    document.getElementById('namaNasabah').innerText = data.nama || data.name || "Nasabah";
                    document.getElementById('nomorKartu').innerText = myCard.replace(/.{4}/g, '$& ');

                    const saldoRaw = data.saldo || 0;
                    const country = data.country || "ID"; 
                    let formattedSaldo = "";
                    let currencyCode = "IDR";

                    if(country === "US") {
                        const kurs = 16666; 
                        const saldoUSD = saldoRaw / kurs;
                        formattedSaldo = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(saldoUSD);
                        currencyCode = "USD";
                    } else {
                        formattedSaldo = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(saldoRaw);
                    }

                    document.getElementById('currencyLabel').innerText = currencyCode;
                    const saldoElem = document.getElementById('saldoNasabah');
                    saldoElem.innerText = formattedSaldo;

                    const len = formattedSaldo.length;
                    if (len > 20) saldoElem.style.fontSize = "1.2rem";
                    else if (len > 15) saldoElem.style.fontSize = "1.6rem";
                    else if (len > 10) saldoElem.style.fontSize = "2.0rem";
                    else saldoElem.style.fontSize = "2.4rem";

                    renderHistory(country);
                }
            } catch (err) { console.error(err); }
        }

        function renderHistory(country) {
            const histContainer = document.getElementById('historyList');
            const currency = country === "US" ? "$" : "Rp";
            const dummyData = [
                { title: "Transfer BCA", date: "Hari ini, 10:00", amount: -500000 },
                { title: "Top Up Gopay", date: "Kemarin", amount: 100000 },
                { title: "Netflix Premium", date: "2 Okt", amount: -180000 }
            ];

            let html = '';
            dummyData.forEach(item => {
                const fmtAmt = Math.abs(item.amount).toLocaleString('id-ID');
                const colorClass = item.amount < 0 ? 'amount-minus' : 'amount-plus';
                const sign = item.amount < 0 ? '-' : '+';
                html += `
                <div class="history-item">
                    <div style="display:flex; align-items:center;">
                        <div class="hist-icon">
                            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        </div>
                        <div class="hist-details">
                            <div class="hist-title">${item.title}</div>
                            <div class="hist-date">${item.date}</div>
                        </div>
                    </div>
                    <div class="hist-amount ${colorClass}">${sign} ${currency} ${fmtAmt}</div>
                </div>`;
            });
            histContainer.innerHTML = html;
        }

        // === 3. TRANSFER LOGIC ===
        let tfTargetData = null;
        
        document.getElementById('tf-targetCard').oninput = async (e) => {
            const val = e.target.value;
            const box = document.getElementById('tf-boxPenerima');
            const btn = document.getElementById('tf-btnProses');
            
            if(val.length >= 10) {
                try {
                    const snap = await get(child(ref(db), `nasabah/${val}`));
                    if(snap.exists()) {
                        tfTargetData = { ...snap.val(), card: val };
                        document.getElementById('tf-namaPenerima').innerText = tfTargetData.nama;
                        document.getElementById('tf-flagPenerima').innerText = tfTargetData.country || 'ID';
                        box.style.display = 'block';
                        validateTransferForm();
                        calculateTransferExchange();
                    } else {
                        box.style.display = 'none'; tfTargetData = null; validateTransferForm();
                    }
                } catch(err) { box.style.display = 'none'; tfTargetData = null; validateTransferForm(); }
            } else {
                box.style.display = 'none'; tfTargetData = null; validateTransferForm();
            }
        };

        let tfRawNominal = 0;
        document.getElementById('tf-amountDisplay').oninput = (e) => {
            let val = e.target.value.replace(/[^0-9]/g, '');
            tfRawNominal = Number(val);
            e.target.value = tfRawNominal ? tfRawNominal.toLocaleString('id-ID') : "";
            validateTransferForm();
            calculateTransferExchange();
        };

        function validateTransferForm() {
            const btn = document.getElementById('tf-btnProses');
            btn.disabled = !(tfTargetData && tfRawNominal > 0);
        }

        function calculateTransferExchange() {
            if(!tfTargetData || !globalUserData || tfRawNominal <= 0) {
                document.getElementById('tf-currencyPreview').style.display = 'none';
                return;
            }
            const cFrom = globalUserData.country || 'ID';
            const cTo = tfTargetData.country || 'ID';
            const RATE = 16000;
            const prev = document.getElementById('tf-currencyPreview');
            const txt = document.getElementById('tf-convertedVal');

            if(cFrom === 'ID' && (cTo === 'US' || cTo === 'ING')) {
                prev.style.display = 'block';
                txt.innerText = "$ " + (tfRawNominal / RATE).toLocaleString('en-US', {minimumFractionDigits: 2});
            } else if((cFrom === 'US' || cFrom === 'ING') && cTo === 'ID') {
                prev.style.display = 'block';
                txt.innerText = "Rp " + Math.round(tfRawNominal * RATE).toLocaleString('id-ID');
            } else {
                prev.style.display = 'none';
            }
        }

        document.getElementById('tf-btnProses').onclick = async () => {
            if(!globalUserData) await initDashboard(); // Ensure data
            
            const pin = prompt("Masukkan PIN Anda:");
            if(pin !== String(globalUserData.pin)) return alert("PIN Salah!");

            try {
                const updates = {};
                updates[`nasabah/${myCard}/saldo`] = globalUserData.saldo - tfRawNominal;
                // Add logic for currency conversion receipt value if needed
                updates[`nasabah/${tfTargetData.card}/saldo`] = tfTargetData.saldo + tfRawNominal;

                await update(ref(db), updates);
                alert("Transfer Berhasil!");
                openSPA('main-dashboard');
                initDashboard();
                // Reset inputs
                document.getElementById('tf-targetCard').value = "";
                document.getElementById('tf-amountDisplay').value = "";
                document.getElementById('tf-boxPenerima').style.display = 'none';
            } catch(e) { alert("Gagal transfer: " + e.message); }
        };

        // === 4. TOPUP LOGIC ===
        let tuNominal = 0;
        let tuPin = "";
        
        function resetTopup() {
            document.getElementById('tu-step1').classList.remove('hidden');
            document.getElementById('tu-step2').classList.add('hidden');
            document.getElementById('tu-step3').classList.add('hidden');
            document.getElementById('tu-step4').classList.add('hidden');
            document.getElementById('tu-customAmount').value = "";
            tuNominal = 0; tuPin = "";
            updateTopupDots();
        }

        document.getElementById('tu-customAmount').oninput = (e) => {
            let val = e.target.value.replace(/[^0-9]/g, '');
            tuNominal = Number(val);
            e.target.value = tuNominal ? tuNominal.toLocaleString('id-ID') : "";
        };

        window.setTopupAmount = (amt) => {
            tuNominal = amt;
            document.getElementById('tu-customAmount').value = amt.toLocaleString('id-ID');
        };

        window.goToTopupPin = () => {
            if(tuNominal <= 0) return alert("Masukkan nominal!");
            document.getElementById('tu-step1').classList.add('hidden');
            document.getElementById('tu-step2').classList.remove('hidden');
        };

        window.pressTopupNum = (n) => {
            if(tuPin.length < 6) { tuPin += n; updateTopupDots(); if(tuPin.length === 6) verifyTopupPin(); }
        };
        window.backspaceTopup = () => { tuPin = tuPin.slice(0,-1); updateTopupDots(); };
        window.clearTopupPin = () => { tuPin = ""; updateTopupDots(); };
        function updateTopupDots() {
            const dots = document.getElementById('tu-pinDots').children;
            for(let i=0; i<6; i++) {
                dots[i].classList.toggle('active', i < tuPin.length);
            }
        }

        async function verifyTopupPin() {
            if(!globalUserData) await initDashboard();
            if(tuPin !== String(globalUserData.pin)) {
                alert("PIN Salah!"); tuPin = ""; updateTopupDots(); return;
            }
            
            document.getElementById('tu-step2').classList.add('hidden');
            document.getElementById('tu-step3').classList.remove('hidden');

            try {
                const snap = await get(child(ref(db), `nasabah/${myCard}`));
                const current = Number(snap.val().saldo);
                await update(ref(db, `nasabah/${myCard}`), { saldo: current + tuNominal });
                
                setTimeout(() => {
                    document.getElementById('tu-step3').classList.add('hidden');
                    document.getElementById('tu-step4').classList.remove('hidden');
                    document.getElementById('tu-resPrice').innerText = "+ Rp " + tuNominal.toLocaleString('id-ID');
                    globalUserData.saldo += tuNominal; // Update local cache
                }, 1500);
            } catch(e) {
                alert("Gagal topup"); resetTopup();
            }
        }

        // === 5. QR SCAN LOGIC ===
        let qsTargetData = null;
        let qsNominal = 0;
        let qsPin = "";

        async function initScanner() {
            if(html5QrCode) return; // Already running
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 250 } };
            
            try {
                await html5QrCode.start({ facingMode: "environment" }, config, async (decodedText) => {
                    await html5QrCode.stop();
                    html5QrCode = null;
                    
                    const snap = await get(ref(db, 'nasabah'));
                    const all = snap.val();
                    for(let id in all) {
                        if(all[id].CodeQR === decodedText && id !== myCard) {
                            qsTargetData = { ...all[id], card: id };
                            break;
                        }
                    }

                    if(qsTargetData) {
                        document.getElementById('qs-targetName').innerText = qsTargetData.nama;
                        document.getElementById('qs-targetCard').innerText = "Rekening: " + qsTargetData.card;
                        document.getElementById('qs-step1').classList.add('hidden');
                        document.getElementById('qs-step2').classList.remove('hidden');
                    } else {
                        alert("QR Tidak Dikenali / Diri Sendiri");
                        initScanner();
                    }
                });
            } catch(err) {
                alert("Kamera Error: " + err);
            }
        }

        window.closeScanner = async () => {
            if(html5QrCode) {
                await html5QrCode.stop();
                html5QrCode = null;
            }
        };

        window.goToQrPin = () => {
            qsNominal = Number(document.getElementById('qs-amount').value);
            if(qsNominal < 1000) return alert("Minimal Rp 1.000");
            document.getElementById('qs-step2').classList.add('hidden');
            document.getElementById('qs-step3').classList.remove('hidden');
        };

        document.getElementById('qs-step3').onclick = (e) => {
            // Handle Numpad clicks if needed, but simpler to use input or simple logic here
            // For simplicity, using a simplified PIN handling similar to Topup but hidden input
            if(e.target.classList.contains('num-btn')) {
                 const n = e.target.innerText;
                 if(n === 'C') { qsPin=""; }
                 else if(n === '‚å´') { qsPin = qsPin.slice(0,-1); }
                 else if(qsPin.length < 6) { qsPin += n; }
                 
                 const dots = document.getElementById('qs-pinDots').children;
                 for(let i=0; i<6; i++) dots[i].classList.toggle('active', i < qsPin.length);
                 
                 if(qsPin.length === 6) processQrTransfer();
            }
        };

        async function processQrTransfer() {
            if(!globalUserData) await initDashboard();
            if(qsPin !== String(globalUserData.pin)) {
                alert("PIN Salah!"); qsPin = ""; 
                const dots = document.getElementById('qs-pinDots').children;
                for(let d of dots) d.classList.remove('active');
                return;
            }

            document.getElementById('qs-step3').classList.add('hidden');
            document.getElementById('qs-step4').classList.remove('hidden');
            document.getElementById('qs-loader').style.display = 'block';
            document.getElementById('qs-success').style.display = 'none';

            try {
                const updates = {};
                updates[`nasabah/${myCard}/saldo`] = globalUserData.saldo - qsNominal;
                updates[`nasabah/${qsTargetData.card}/saldo`] = qsTargetData.saldo + qsNominal;
                await update(ref(db), updates);

                document.getElementById('qs-resName').innerText = qsTargetData.nama;
                document.getElementById('qs-resAmt').innerText = "Rp " + qsNominal.toLocaleString('id-ID');
                
                document.getElementById('qs-loader').style.display = 'none';
                document.getElementById('qs-success').style.display = 'block';
                globalUserData.saldo -= qsNominal; // Update cache
            } catch(e) {
                alert("Gagal Transfer"); openSPA('page-qrscan');
            }
        }

        window.downloadQrStruk = () => {
            const el = document.getElementById('strukPrint');
            html2canvas(el).then(canvas => {
                const a = document.createElement('a');
                a.download = `STRUK_${Date.now()}.png`;
                a.href = canvas.toDataURL();
                a.click();
            });
        };
        // Add numpad dynamically for QR Scan to match Topup UI
        const qsPad = document.createElement('div');
        qsPad.className = 'numpad';
        qsPad.innerHTML = `
            <button class="num-btn">1</button><button class="num-btn">2</button><button class="num-btn">3</button>
            <button class="num-btn">4</button><button class="num-btn">5</button><button class="num-btn">6</button>
            <button class="num-btn">7</button><button class="num-btn">8</button><button class="num-btn">9</button>
            <button class="num-btn" style="color:#ef4444">C</button><button class="num-btn">0</button><button class="num-btn">‚å´</button>
        `;
        document.getElementById('qs-step3').appendChild(qsPad);


        // === 6. QR PAY LOGIC ===
        async function initQrPay() {
            if(!globalUserData) await initDashboard();
            const data = globalUserData;
            const inactive = document.getElementById('qp-viewInactive');
            const verify = document.getElementById('qp-viewVerify');
            const qr = document.getElementById('qp-viewQR');

            if(!data.qrActive || !data.CodeQR) {
                inactive.classList.remove('hidden');
                verify.classList.add('hidden');
                qr.classList.add('hidden');
            } else {
                // Check session
                if(localStorage.getItem('qrVerified') === 'true') {
                    showMyQR();
                } else {
                    inactive.classList.add('hidden');
                    verify.classList.remove('hidden');
                    qr.classList.add('hidden');
                }
            }
        }

        document.getElementById('qp-btnVerify').onclick = () => {
            const input = document.getElementById('qp-inputCode').value;
            if(input === String(globalUserData.CodeQR)) {
                document.getElementById('qp-viewVerify').classList.add('hidden');
                document.getElementById('qp-viewQR').classList.remove('hidden');
                showMyQR();
                localStorage.setItem('qrVerified', 'true');
            } else {
                alert("Kode Salah!");
            }
        };

        function showMyQR() {
            document.getElementById('qp-userName').innerText = globalUserData.nama;
            document.getElementById('qp-userCardDisplay').innerText = myCard.replace(/.{4}/g, '$& ');
            
            const container = document.getElementById("qrcode");
            container.innerHTML = "";
            new QRCode(container, {
                text: String(globalUserData.CodeQR),
                width: 220, height: 220,
                colorDark : "#0f172a",
                colorLight : "#ffffff"
            });
        }

        // === 7. SETTINGS LOGIC ===
        async function initSettings() {
            if(!globalUserData) await initDashboard();
            const chk = document.getElementById('set-switchQR');
            chk.checked = !!globalUserData.qrActive;
        }

        window.toggleQRSetting = async () => {
            const isChecked = document.getElementById('set-switchQR').checked;
            try {
                await update(ref(db, `nasabah/${myCard}`), { qrActive: isChecked });
                globalUserData.qrActive = isChecked; // Cache update
                if(!isChecked) localStorage.removeItem('qrVerified');
            } catch(e) {
                alert("Gagal update setting");
                document.getElementById('set-switchQR').checked = !isChecked;
            }
        };

        // === LOGOUT ===
        document.getElementById('btnLogout').onclick = async () => {
            if(confirm("Keluar dari akun?")) {
                if(myCard) {
                    try { await update(ref(db, `nasabah/${myCard}`), { MyAccount: "nonactive" }); } catch(e){}
                }
                localStorage.clear();
                // Arahkan ke file login kamu
                window.location.href = './index.html'; // Asumsi file login
            }
        };

        // Init First Load
        window.onload = () => {
            if(myCard) initDashboard();
            else alert("Data user tidak ditemukan. Silakan login ulang.");
        };

    </script>
</body>
</html>
