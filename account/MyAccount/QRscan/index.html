<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner | Bank Devisa</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --accent: #b8924e; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; display: none; }
        .card.active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; margin-bottom: 20px; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 10px; font-size: 1rem; text-align: center; outline: none; }
        .btn-gold { background: var(--dark); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 20px; cursor: pointer; }
        .dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid #cbd5e1; }
        .dot.active { background: var(--accent); border-color: var(--accent); }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="stepScan" class="card active">
        <h3 style="margin-bottom: 20px;">Scan QR Penerima</h3>
        <div id="reader"></div>
        <button class="btn-gold" style="background: #64748b;" onclick="location.href='../index.html'">BATAL</button>
    </div>

    <div id="stepNominal" class="card">
        <div style="font-size: 3rem;">ðŸ‘¤</div>
        <h2 id="targetName">---</h2>
        <p style="font-size: 0.8rem; color: #64748b;">Masukkan nominal transfer</p>
        <input type="number" id="amount" placeholder="Rp 0" style="font-weight: 800; color: var(--accent); font-size: 1.5rem;">
        <button class="btn-gold" onclick="goToPin()">LANJUTKAN</button>
    </div>

    <div id="stepPin" class="card">
        <h3>PIN Keamanan</h3>
        <div style="display: flex; justify-content: center; gap: 10px; margin: 20px 0;">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <input type="password" id="pinInput" maxlength="6" autofocus style="opacity: 0; position: absolute;">
    </div>

    <div id="stepLoading" class="card">
        <div id="loader"><div class="spinner"></div><p>Memproses...</p></div>
        <div id="success" style="display:none;">
            <div style="font-size: 4rem;">âœ…</div>
            <h2>Transfer Berhasil</h2>
            <div style="background: #f1f5f9; padding: 15px; border-radius: 15px; text-align: left; margin: 15px 0;">
                <p id="resName" style="font-weight:700; margin:0;"></p>
                <p id="resAmt" style="color: var(--accent); font-weight:800; margin:0;"></p>
            </div>
            <button class="btn-gold" onclick="location.href='../index.html'">KEMBALI</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXYDqFmhO8nacuX-hVnNsXMmpeqwYlW7U",
        databaseURL: "https://wifist-d3588-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "wifist-d3588"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let html5QrCode, targetData, myData;
    const myCard = sessionStorage.getItem('userCard');

    window.onload = async () => {
        const snap = await get(child(ref(db), `nasabah/${myCard}`));
        myData = snap.val();
        
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    };

    async function onScanSuccess(decodedText) {
        html5QrCode.stop();
        const snap = await get(ref(db, 'nasabah'));
        const users = snap.val();
        
        for (let id in users) {
            if (users[id].CodeQR === decodedText) {
                targetData = { ...users[id], card: id };
                break;
            }
        }

        if (targetData) {
            document.getElementById('targetName').innerText = targetData.nama || targetData.name;
            showStep('stepNominal');
        } else { alert("QR Tidak Terdaftar!"); location.reload(); }
    }

    window.goToPin = () => {
        if(document.getElementById('amount').value < 1000) return alert("Minimal Rp 1.000");
        showStep('stepPin');
        document.getElementById('pinInput').focus();
    };

    document.getElementById('pinInput').oninput = function() {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.classList.toggle('active', i < this.value.length));
        if (this.value.length === 6) processTx(this.value);
    };

    async function processTx(pin) {
        if (pin !== String(myData.pin || myData.PIN)) {
            alert("PIN Salah!"); this.value = ""; return;
        }

        const amt = parseInt(document.getElementById('amount').value);
        if (myData.saldo < amt) { alert("Saldo Tidak Cukup!"); location.reload(); return; }

        showStep('stepLoading');
        
        // Update Firebase
        await update(ref(db, `nasabah/${myCard}`), { saldo: myData.saldo - amt });
        await update(ref(db, `nasabah/${targetData.card}`), { saldo: targetData.saldo + amt });

        document.getElementById('loader').style.display = "none";
        document.getElementById('success').style.display = "block";
        document.getElementById('resName').innerText = targetData.nama || targetData.name;
        document.getElementById('resAmt').innerText = "Rp " + amt.toLocaleString();
    }

    function showStep(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
