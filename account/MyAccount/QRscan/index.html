<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner | Bank Devisa</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --accent: #b8924e; --dark: #0f172a; --bg: #f8fafc; --success: #22c55e; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        
        .card { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; display: none; overflow: hidden; }
        .card.active { display: block; animation: slideUp 0.3s ease; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scanner Styling */
        #reader { width: 100%; border-radius: 20px; overflow: hidden; margin-bottom: 20px; background: #000; }
        #reader video { object-fit: cover !important; border-radius: 20px; }

        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 10px; font-size: 1rem; text-align: center; outline: none; box-sizing: border-box; }
        
        .btn-gold { background: var(--dark); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 10px; cursor: pointer; transition: 0.3s; }
        .btn-gold:active { transform: scale(0.98); }
        .btn-download { background: var(--success); margin-top: 20px; }

        .dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid #cbd5e1; }
        .dot.active { background: var(--accent); border-color: var(--accent); }
        
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .receipt-box { background: #f1f5f9; padding: 20px; border-radius: 20px; text-align: left; margin: 20px 0; border: 1px dashed #cbd5e1; }
    </style>
</head>
<body>

    <div id="stepScan" class="card active">
        <h3 style="margin-bottom: 10px;">Pindai QR Penerima</h3>
        <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 20px;">Arahkan kamera ke kode QR nasabah</p>
        <div id="reader"></div>
        <button class="btn-gold" style="background: #64748b;" onclick="location.href='../index.html'">KEMBALI</button>
    </div>

    <div id="stepNominal" class="card">
        <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ‘¤</div>
        <h2 id="targetName" style="margin: 0;">---</h2>
        <p id="targetCard" style="font-size: 0.8rem; color: #64748b; margin-bottom: 20px;">Rekening Tujuan</p>
        <label style="font-size: 0.8rem; font-weight: 700; display: block; text-align: left;">Nominal Transfer</label>
        <input type="number" id="amount" placeholder="Rp 0" style="font-weight: 800; color: var(--accent); font-size: 1.5rem;">
        <button class="btn-gold" onclick="goToPin()">LANJUTKAN</button>
    </div>

    <div id="stepPin" class="card">
        <h3>PIN Keamanan</h3>
        <p style="font-size: 0.8rem; color: #64748b;">Masukkan 6 digit PIN Anda</p>
        <div style="display: flex; justify-content: center; gap: 10px; margin: 30px 0;">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <input type="password" id="pinInput" maxlength="6" inputmode="numeric" autofocus style="opacity: 0; position: absolute;">
    </div>

    <div id="stepLoading" class="card">
        <div id="loader">
            <div class="spinner"></div>
            <p>Memproses Transaksi...</p>
        </div>
        
        <div id="success" style="display:none;">
            <div style="font-size: 4rem; margin-bottom: 10px;">âœ…</div>
            <h2 style="margin: 0;">Transfer Berhasil</h2>
            
            <div class="receipt-box" id="strukContent">
                <p style="font-size: 0.7rem; color: #64748b; margin: 0;">Penerima:</p>
                <p id="resName" style="font-weight:800; font-size: 1.1rem; margin-bottom: 10px;"></p>
                <p style="font-size: 0.7rem; color: #64748b; margin: 0;">Jumlah:</p>
                <p id="resAmt" style="color: var(--accent); font-weight:800; font-size: 1.3rem; margin: 0;"></p>
                <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">
                <p style="font-size: 0.6rem; color: #94a3b8; text-align: center;">Bank Devisa Nusantara - Simpan struk ini sebagai bukti sah.</p>
            </div>
            
            <button class="btn-gold btn-download" onclick="downloadStruk()">SIMPAN STRUK</button>
            <button class="btn-gold" style="background: transparent; color: var(--dark); border: 1px solid var(--dark);" onclick="location.href='../index.html'">SELESAI</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXYDqFmhO8nacuX-hVnNsXMmpeqwYlW7U",
        databaseURL: "https://wifist-d3588-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "wifist-d3588"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let html5QrCode, targetData, myData;
    const myCard = sessionStorage.getItem('userCard');

    // REDIRECT JIKA TIDAK LOGIN
    if (!myCard) { location.href = '../index.html'; }

    window.onload = async () => {
        // Load Data Pengirim
        const snap = await get(child(ref(db), `nasabah/${myCard}`));
        myData = snap.val();
        
        // Start Scanner
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => alert("Kamera Error: Ganti ke HTTPS atau beri izin kamera."));
    };

    async function onScanSuccess(decodedText) {
        await html5QrCode.stop();
        
        const snap = await get(ref(db, 'nasabah'));
        const users = snap.val();
        
        for (let id in users) {
            if (users[id].CodeQR === decodedText) {
                if (id === myCard) { alert("Tidak bisa transfer ke diri sendiri!"); location.reload(); return; }
                targetData = { ...users[id], card: id };
                break;
            }
        }

        if (targetData) {
            document.getElementById('targetName').innerText = targetData.nama || targetData.name;
            document.getElementById('targetCard').innerText = "Rek: " + targetData.card;
            showStep('stepNominal');
        } else { 
            alert("QR Tidak Terdaftar!"); 
            location.reload(); 
        }
    }

    window.goToPin = () => {
        const amt = document.getElementById('amount').value;
        if(amt < 1000) return alert("Minimal transfer Rp 1.000");
        if(amt > myData.saldo) return alert("Saldo Anda tidak mencukupi!");
        
        showStep('stepPin');
        document.getElementById('pinInput').focus();
    };

    document.getElementById('pinInput').oninput = function() {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.classList.toggle('active', i < this.value.length));
        if (this.value.length === 6) processTx(this.value);
    };

    async function processTx(pin) {
        const correctPin = String(myData.pin || myData.PIN);
        if (pin !== correctPin) {
            alert("PIN Salah!");
            document.getElementById('pinInput').value = "";
            document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
            return;
        }

        const amt = parseInt(document.getElementById('amount').value);
        showStep('stepLoading');
        
        try {
            // Update Saldo Real-time
            await update(ref(db, `nasabah/${myCard}`), { saldo: myData.saldo - amt });
            await update(ref(db, `nasabah/${targetData.card}`), { saldo: targetData.saldo + amt });

            // Tampilkan Halaman Sukses
            document.getElementById('loader').style.display = "none";
            document.getElementById('success').style.display = "block";
            document.getElementById('resName').innerText = targetData.nama || targetData.name;
            document.getElementById('resAmt').innerText = "Rp " + amt.toLocaleString('id-ID');
        } catch (e) {
            alert("Terjadi kesalahan koneksi!");
            location.reload();
        }
    }

    // FUNGSI DOWNLOAD STRUK
    window.downloadStruk = () => {
        const element = document.getElementById('stepLoading');
        html2canvas(element, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Struk-${targetData.card}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    };

    function showStep(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
