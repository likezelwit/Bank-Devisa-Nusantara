<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner | Bank Devisa</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --accent: #b8924e; --dark: #0f172a; --bg: #f8fafc; --success: #22c55e; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        
        .card { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; display: none; box-sizing: border-box; }
        .card.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        #reader { width: 100%; border-radius: 20px; overflow: hidden; margin-bottom: 20px; background: #000; min-height: 250px; }
        #reader video { object-fit: cover !important; border-radius: 20px; }
        
        input { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; margin-top: 10px; font-size: 1.2rem; text-align: center; outline: none; font-weight: 600; }
        .btn-gold { background: var(--dark); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 15px; cursor: pointer; transition: 0.2s; }
        .btn-gold:active { transform: scale(0.97); }
        
        .dot-container { display: flex; justify-content: center; gap: 12px; margin: 25px 0; }
        .dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #cbd5e1; transition: 0.2s; }
        .dot.active { background: var(--accent); border-color: var(--accent); transform: scale(1.2); }
        
        .spinner { width: 45px; height: 45px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .receipt { background: #f1f5f9; padding: 20px; border-radius: 20px; text-align: left; margin: 20px 0; border: 2px dashed #cbd5e1; }
        .receipt h4 { margin: 0; color: #64748b; font-size: 0.75rem; text-transform: uppercase; }
        .receipt p { margin: 5px 0 15px 0; font-weight: 800; font-size: 1.1rem; color: var(--dark); }
    </style>
</head>
<body>

    <div id="stepScan" class="card active">
        <h3 style="margin-top: 0;">Pindai QR Nasabah</h3>
        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 20px;">Arahkan kamera ke kode QR tujuan</p>
        <div id="reader"></div>
        <button class="btn-gold" style="background: #ef4444;" onclick="location.href='../index.html'">BATAL</button>
    </div>

    <div id="stepNominal" class="card">
        <div style="font-size: 4rem;">ðŸ‘¤</div>
        <h2 id="targetName" style="margin: 10px 0 5px 0;">---</h2>
        <p id="targetCard" style="margin: 0; color: #64748b; font-size: 0.9rem; font-weight: 600;">Rekening: ---</p>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
        <p style="text-align: left; font-size: 0.8rem; font-weight: 700; color: var(--dark);">NOMINAL TRANSFER</p>
        <input type="number" id="amount" placeholder="Rp 0">
        <button class="btn-gold" onclick="goToPin()">LANJUTKAN</button>
    </div>

    <div id="stepPin" class="card">
        <h3>Konfirmasi PIN</h3>
        <p style="font-size: 0.85rem; color: #64748b;">Masukkan 6 digit PIN keamanan anda</p>
        <div class="dot-container">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <input type="password" id="pinInput" maxlength="6" inputmode="numeric" style="opacity: 0; position: absolute;">
    </div>

    <div id="stepFinal" class="card">
        <div id="loader">
            <div class="spinner"></div>
            <p style="font-weight: 600;">Sedang Memproses...</p>
        </div>
        
        <div id="success" style="display:none;">
            <div style="font-size: 4rem;">âœ…</div>
            <h2 style="margin: 10px 0;">Transfer Berhasil</h2>
            
            <div class="receipt" id="strukPrint">
                <h4>Penerima</h4>
                <p id="resName"></p>
                <h4>Nominal</h4>
                <p id="resAmt" style="color: var(--accent); font-size: 1.4rem;"></p>
                <div style="font-size: 0.65rem; color: #94a3b8; text-align: center; margin-top: 10px;">
                    Bank Devisa Nusantara - Bukti Transfer Sah
                </div>
            </div>
            
            <button class="btn-gold" style="background: var(--success);" onclick="downloadStruk()">SIMPAN STRUK</button>
            <button class="btn-gold" style="background: transparent; color: var(--dark); border: 2px solid var(--dark);" onclick="location.href='../index.html'">SELESAI</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXYDqFmhO8nacuX-hVnNsXMmpeqwYlW7U",
        databaseURL: "https://wifist-d3588-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "wifist-d3588"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let html5QrCode, targetData, myData;
    const myCard = sessionStorage.getItem('userCard');

    // Mencegah akses jika tidak login
    if (!myCard) { location.href = '../index.html'; }

    window.onload = async () => {
        try {
            // 1. Ambil data pengirim dulu
            const snap = await get(child(ref(db), `nasabah/${myCard}`));
            if (snap.exists()) {
                myData = snap.val();
                // 2. Jika data ada, baru nyalakan kamera
                initScanner();
            } else {
                alert("Sesi tidak valid!");
                location.href = '../index.html';
            }
        } catch (e) {
            console.error(e);
        }
    };

    function initScanner() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 15, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("Kamera error! Pastikan izin kamera aktif dan gunakan HTTPS.");
            });
    }

    async function onScanSuccess(decodedText) {
        try {
            await html5QrCode.stop(); // Berhenti setelah dapat kode
            
            const snap = await get(ref(db, 'nasabah'));
            const allUsers = snap.val();
            
            for (let id in allUsers) {
                if (allUsers[id].CodeQR === decodedText) {
                    if (id === myCard) {
                        alert("Tidak bisa transfer ke diri sendiri!");
                        location.reload();
                        return;
                    }
                    targetData = { ...allUsers[id], card: id };
                    break;
                }
            }

            if (targetData) {
                document.getElementById('targetName').innerText = targetData.nama || "Nasabah BDN";
                document.getElementById('targetCard').innerText = "Rekening: " + targetData.card;
                showStep('stepNominal');
            } else {
                alert("QR Nasabah tidak terdaftar di sistem!");
                location.reload();
            }
        } catch (e) {
            console.error("Scan Error:", e);
        }
    }

    window.goToPin = () => {
        const amt = parseInt(document.getElementById('amount').value);
        if (!amt || amt < 1000) return alert("Minimal transfer Rp 1.000");
        if (amt > myData.saldo) return alert("Saldo tidak cukup!");
        
        showStep('stepPin');
        setTimeout(() => document.getElementById('pinInput').focus(), 400);
    };

    document.getElementById('pinInput').oninput = function() {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.classList.toggle('active', i < this.value.length));
        if (this.value.length === 6) processTransfer(this.value);
    };

    async function processTransfer(pin) {
        const inputPin = String(pin);
        const actualPin = String(myData.pin || myData.PIN);

        if (inputPin !== actualPin) {
            alert("PIN Keamanan Salah!");
            document.getElementById('pinInput').value = "";
            document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
            return;
        }

        const amt = parseInt(document.getElementById('amount').value);
        showStep('stepFinal');

        try {
            // Update Database Realtime
            const updates = {};
            updates[`nasabah/${myCard}/saldo`] = myData.saldo - amt;
            updates[`nasabah/${targetData.card}/saldo`] = targetData.saldo + amt;
            
            await update(ref(db), updates);

            // Munculkan Struk
            document.getElementById('loader').style.display = "none";
            document.getElementById('success').style.display = "block";
            document.getElementById('resName').innerText = targetData.nama;
            document.getElementById('resAmt').innerText = "Rp " + amt.toLocaleString('id-ID');
        } catch (err) {
            alert("Koneksi bermasalah, coba lagi!");
            location.reload();
        }
    }

    window.downloadStruk = () => {
        const captureArea = document.getElementById('strukPrint');
        html2canvas(captureArea, { backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement('a');
            link.download = `STRUK_BDN_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    };

    function showStep(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
